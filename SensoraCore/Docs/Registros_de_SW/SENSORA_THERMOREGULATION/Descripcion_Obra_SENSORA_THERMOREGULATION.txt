DESCRIPCIÓN DE OBRA - SENSORA THERMOREGULATION
==================================================

DESCRIPCIÓN:
El módulo SENSORA_THERMOREGULATION es un sistema avanzado de monitoreo térmico multi-sensor que integra tres tecnologías complementarias de medición de temperatura: sensores analógicos LM35, sensores digitales DS18B20 con protocolo OneWire y termopares Tipo K con amplificador MAX6675. Este sistema está diseñado para aplicaciones industriales, científicas y educativas que requieren medición precisa de temperatura con capacidades de calibración avanzada y análisis temporal de datos térmicos.

El sistema implementa algoritmos sofisticados de calibración polinómica (lineal y cuadrática) que permiten compensar derivas y no-linealidades inherentes a cada tecnología de sensado, proporcionando mediciones trazables y repetibles. La arquitectura modular facilita la integración en sistemas de control térmico, investigación en transferencia de calor y aplicaciones educativas en instrumentación térmica.

DISEÑO:
La arquitectura del sistema se basa en un diseño modular de tres capas principales que garantizan separación de responsabilidades y escalabilidad:

1. Capa de Adquisición y Comunicación:
   - Clase ThermoThread implementando QThread para comunicación TCP asíncrona
   - Protocolo especializado con comandos TH_SET, TH_START, TH_STOP
   - Soporte simultáneo para tres sensores con selección dinámica
   - Parseo robusto de datos con formato específico por tecnología de sensor

2. Capa de Procesamiento y Calibración:
   - Algoritmos de calibración lineal y cuadrática con regresión least-squares
   - Sistema de persistencia JSON para coeficientes de calibración
   - Compensación matemática automática aplicada a datos en tiempo real
   - Gestión de incertidumbre y validación de rangos por sensor

3. Capa de Interfaz y Visualización:
   - Clase ThermoregulationLogic como controlador principal del módulo
   - Interfaz gráfica con selección exclusiva de sensores
   - Visualización matplotlib con múltiples series temporales simultáneas
   - Sistema de exportación Excel con múltiples hojas de datos y metadatos

El diseño de la interfaz sigue principios de instrumentación científica con paneles especializados: selector de sensores con indicadores de estado, tabla de datos en tiempo real mostrando valores crudos y calibrados, gráfica científica con escalado automático y controles de operación agrupados funcionalmente.

IMPLEMENTACIÓN:
La implementación se desarrolló utilizando programación orientada a objetos con Python 3.8+, aprovechando las capacidades de multithreading de PySide6 y bibliotecas científicas especializadas (numpy, pandas, matplotlib). El sistema utiliza dataclasses para manejo eficiente de estructuras de calibración y patrones de persistencia JSON para configuraciones de usuario.

Componentes Principales Implementados:

1. Sistema de Comunicación Multi-Sensor:
   - Clase ThermoThread con señales especializadas data(sensor_name, temp_c, raw)
   - Protocolo TCP robusto con timeout configurables y reconexión automática
   - Comando de inicialización "MODO:THERMOREGULATION" con confirmación
   - Parsing diferenciado por formato de sensor: LM35 (TEMP_C+RAW), DS18B20 (TEMP_C), TYPEK (TEMP_C+RAW)

2. Algoritmos de Calibración Avanzados:
   - Función linear_calibration() utilizando numpy.polyfit para regresión de primer orden
   - Función quadratic_calibration() para regresión de segundo orden específica para termopares
   - Sistema de persistencia con archivo ~/.sensora_core/thermo_calib.json
   - Wizard interactivo _calibrate_dialog() para captura de puntos de referencia

3. Procesamiento Matemático Especializado:
   - Conversión LM35: voltage = (adc/4095)*3.3, temp = voltage*100 (10mV/°C)
   - Procesamiento DS18B20: valor directo digital con resolución 0.0625°C
   - Procesamiento MAX6675: raw_data>>3, temperatura = data*0.25°C, detección desconexión
   - Aplicación de calibración: T_real = a*T_measured + b (lineal) o a*T²+b*T+c (cuadrática)

4. Visualización Científica Avanzada:
   - Integración matplotlib con FigureCanvasQTAgg para embedding Qt nativo
   - Tres series temporales diferenciadas por color para LM35, DS18B20, TYPEK
   - Escalado automático de ejes con preservación de aspect ratio científico
   - Actualización tiempo real optimizada con draw_idle() y gestión de memoria

La arquitectura de exportación utiliza openpyxl para generación de archivos Excel profesionales con cuatro hojas especializadas: datos temporales con timestamps, metadatos de sesión y configuración, parámetros de calibración por sensor y gráfica embebida como imagen PNG de alta resolución.

FUNCIONES:
El sistema proporciona un conjunto completo de funcionalidades para análisis térmico cuantitativo y control de calidad:

Funciones de Control y Adquisición:
- start(): Inicializa comunicación TCP y streaming de datos térmicos
- stop(): Finaliza comunicación de forma controlada con cleanup completo
- _select_sensor(): Cambia dinámicamente entre LM35, DS18B20, TYPEK durante operación
- _set_period(): Configura intervalo de muestreo optimizado por tecnología de sensor

Funciones de Calibración y Compensación:
- _calibrate_dialog(): Wizard interactivo para calibración multi-punto
- _apply_calibration(): Aplica compensación matemática en tiempo real
- linear_calibration(): Regresión lineal para LM35 y DS18B20
- quadratic_calibration(): Regresión cuadrática para termopares Tipo K
- _load_calibration(): Carga coeficientes persistentes desde JSON
- _save_calibration(): Almacena parámetros con validación de integridad

Funciones de Procesamiento de Datos:
- _on_data(): Procesa datos entrantes con validación de formato por sensor
- _convert_lm35(): Conversión ADC→voltaje→temperatura con factor 10mV/°C
- _process_ds18b20(): Manejo de datos digitales OneWire con resolución variable
- _process_typek(): Decodificación MAX6675 con detección de termopar desconectado

Funciones de Visualización Científica:
- _setup_plot(): Inicialización matplotlib con configuración científica multi-serie
- _update_plot(): Actualización tiempo real con gestión eficiente de memoria
- _clear_data(): Reset completo de series temporales y visualización
- Escalado automático de ejes preservando legibilidad científica

Funciones de Exportación y Documentación:
- _export_excel(): Exportación completa multi-hoja con metadatos técnicos
- _export_csv(): Exportación simple para análisis en software externo
- _generate_plot_image(): Creación de imagen PNG para documentación
- Hoja "Datos": Series temporales con timestamps de alta precisión
- Hoja "Calibracion": Ecuaciones y coeficientes por sensor
- Hoja "Metadatos": Información de sesión y configuración instrumental

Funciones Auxiliares y Utilidades:
- _get_ip(): Extracción IP desde widget principal con validación de formato
- _validate_sensor_range(): Verificación de rangos operativos por tecnología
- _calculate_uncertainty(): Estimación de incertidumbre combinada de medición
- cleanup(): Liberación controlada de recursos al cerrar módulo

VALIDACIÓN:
El sistema implementa múltiples capas de validación para garantizar mediciones confiables y trazables:

Validación de Hardware y Comunicación:
- Verificación de respuesta "THERMOREGULATION_OK" del firmware ESP32
- Test de comunicación individual por sensor con timeout específico
- Monitoreo continuo de integridad de datos con detección de pérdida de sincronía
- Validación de comandos TH_SET con confirmación de cambio de sensor

Validación de Calibración y Metrología:
- Verificación de regresión lineal con coeficiente de determinación R² > 0.95
- Validación de regresión cuadrática para termopares con análisis de residuos
- Comprobación de rangos de validez de calibración por sensor
- Test de deriva temporal con mediciones de referencia periódicas

Validación de Datos y Mediciones:
- Parsing robusto con detección de mensajes malformados o corruptos
- Validación de rangos físicos por tecnología: LM35 (-55°C a +150°C), DS18B20 (-55°C a +125°C), TYPEK (0°C a +1024°C)
- Detección automática de termopar desconectado mediante bit de estado MAX6675
- Filtrado de outliers mediante criterios de sigma y validación de gradiente temporal

Validación de Interfaz y Operación:
- Verificación de existencia de widgets Qt antes de operaciones críticas
- Manejo de errores matplotlib con fallback graceful en caso de fallo de visualización
- Validación de permisos de escritura para exportación de archivos
- Confirmación de operaciones críticas como reset de calibración

Métricas de Calidad Implementadas:
- Exactitud: ±0.5°C para LM35 y DS18B20, ±3°C para termopares
- Precisión: Repetibilidad < 0.1°C en mediciones consecutivas
- Estabilidad temporal: Deriva < 0.1°C/mes en operación continua
- Resolución efectiva: 0.08°C (LM35), 0.0625°C (DS18B20), 0.25°C (TYPEK)

Algoritmos de Auto-Validación:
- Verificación automática de estabilidad térmica pre-calibración
- Detección de condiciones ambientales anómalas (gradientes excesivos)
- Validación cruzada entre sensores cuando operan en rangos superpuestos
- Sistema de alertas para condiciones operativas sub-óptimas o fuera de especificación

PLATAFORMA:
El sistema está diseñado para operar de manera robusta en múltiples plataformas con enfoque en aplicaciones científicas e industriales:

Plataforma de Desarrollo:
- Lenguaje: Python 3.8+ con type hints para robustez y mantenibilidad
- Framework GUI: PySide6 (Qt 6.x) para interfaz nativa multiplataforma
- Librerías científicas: numpy 1.20+ para cálculos matemáticos optimizados
- Análisis de datos: pandas 1.3+ para manejo de series temporales
- Visualización: matplotlib 3.5+ con backend Qt para integración perfecta
- Exportación: openpyxl 3.0+ para archivos Excel profesionales

Sistemas Operativos Soportados:
- Windows 10/11 (64-bit) - Plataforma principal para aplicaciones industriales
- Linux Ubuntu 20.04 LTS+ y distribuciones científicas (Debian, CentOS)
- macOS 11+ (Big Sur) con soporte completo Apple Silicon M1/M2
- Raspberry Pi OS para implementaciones embebidas de monitoreo

Hardware Mínimo Requerido:
- CPU: Dual-core 2.0 GHz (Intel Core i3 o AMD equivalente)
- RAM: 4 GB (8 GB recomendado para análisis de datasets extensos)
- Almacenamiento: 2 GB disponibles (incluye dependencias científicas)
- Conectividad: WiFi 802.11n o Ethernet para comunicación con ESP32
- Puertos: USB 3.0+ para transferencia rápida de datos experimentales

Hardware Científico Recomendado:
- CPU: Quad-core 3.0 GHz+ con soporte de punto flotante optimizado
- RAM: 16 GB+ para análisis simultáneo de múltiples experimentos
- GPU: Soporte OpenGL 4.0+ para aceleración de visualización matplotlib
- Monitor: 1920x1080+ con calibración de color para visualización científica
- Red: Gigabit Ethernet para comunicación estable en ambientes industriales

Dependencias del Sistema:
- Python: Instalación oficial con compilador C para extensiones numpy
- Qt6: Sistema de ventanas nativo con soporte OpenGL
- BLAS/LAPACK: Bibliotecas matemáticas optimizadas para cálculos matriciales
- Compilador: GCC (Linux), Xcode (macOS), MSVC (Windows) para componentes nativos

AMBIENTE:
El ambiente de ejecución está optimizado para aplicaciones científicas, educativas e industriales:

Ambiente Científico:
- IDE recomendado: JupyterLab para análisis interactivo de datos térmicos
- Control de versiones: Git con hooks pre-commit para calidad de código científico
- Documentación: Sphinx con extensiones científicas para generación automática
- Testing: pytest con fixtures especializadas para datos térmicos sintéticos
- Profiling: line_profiler para optimización de algoritmos tiempo real

Configuración de Red Industrial:
- Protocolo: TCP/IP sobre Ethernet industrial o WiFi certificado
- Puerto estándar: 8080 con configuración de firewall para seguridad
- Timeout: 5 segundos para detección rápida de fallas de comunicación
- Keepalive: Implementado para detección de desconexiones silenciosas
- Seguridad: Encriptación TLS opcional para aplicaciones críticas

Ambiente de Producción:
- Directorio trabajo: Configurable por administrador con permisos apropiados
- Archivos configuración: ~/.sensora_core/ con backup automático
- Logs operación: Sistema logging con rotación y niveles configurables
- Calibraciones: Persistencia con trazabilidad y backup periódico automático
- Exportaciones: Directorio configurable con validación de espacio disponible

Variables de Entorno Críticas:
- PYTHONPATH: Configurada para módulos SENSORA CORE y dependencias científicas
- QT_QPA_PLATFORM: Optimizada para rendering en sistemas industriales
- MPLBACKEND: Qt6Agg para integración perfecta con interfaz principal
- THERMO_CONFIG_DIR: Override directorio configuración para instalaciones multi-usuario
- NUMPY_NUM_THREADS: Control de paralelización para sistemas embebidos

Consideraciones de Seguridad Industrial:
- Segregación de red: VLAN dedicada para instrumentación térmica
- Autenticación: Integración opcional con sistemas de control de acceso
- Trazabilidad: Logs detallados para auditorías de calidad ISO 9001
- Backup: Procedimientos automáticos para calibraciones críticas de proceso
- Validación: Comparación automática con patrones de referencia certificados

Optimizaciones de Rendimiento:
- Threading: Separación completa de adquisición, procesamiento y visualización
- Memoria: Gestión eficiente para sesiones de monitoreo extendidas (>24h)
- CPU: Algoritmos vectorizados con numpy para procesamiento de calibración
- I/O: Escritura asíncrona para exportación de archivos grandes sin bloqueo UI
- Red: Buffer optimizado y compresión opcional para minimizar latencia

Integración con Ecosistema Científico:
- MATLAB: Exportación compatible con Instrument Control Toolbox
- LabVIEW: Interfaz TCP compatible con LabVIEW Real-Time
- SCADA: Integración posible con sistemas de supervisión industrial
- Databases: Conectores para InfluxDB y bases de datos de series temporales
- Cloud: APIs para integración con plataformas IoT industriales
    - **Firmware:** MicroPython en el ESP32, con lógica para leer los tres tipos de sensores.
- **Hardware:**
    - **Microcontrolador:** ESP32.
    - **Sensores:** LM35, DS18B20, Termopar Tipo K con módulo amplificador MAX6675.

**7. Ambiente**
La aplicación se ejecuta en un entorno de escritorio Windows y requiere una conexión de red local (LAN/WLAN) compartida con el dispositivo ESP32 para la comunicación TCP.
