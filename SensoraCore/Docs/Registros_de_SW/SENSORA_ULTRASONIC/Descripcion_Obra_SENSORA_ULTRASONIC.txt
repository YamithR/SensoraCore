# DESCRIPCIÓN DE OBRA - SENSORA ULTRASONIC

---

## DESCRIPCIÓN

El módulo SENSORA_ULTRASONIC constituye un sistema integral de medición de distancia por ultrasonido diseñado para aplicaciones educativas y de investigación. Implementa una solución completa que combina hardware de sensores HC-SR04 con ESP32 y software de escritorio desarrollado en Python/PySide6, proporcionando capacidades avanzadas de medición, calibración y análisis de datos en tiempo real.

El sistema está orientado a la enseñanza de principios físicos de propagación de ondas, instrumentación electrónica y desarrollo de software para aplicaciones de medición. Permite a estudiantes y educadores explorar conceptos desde nivel básico (propagación del sonido) hasta avanzado (algoritmos de calibración y comunicación TCP/IP).

---

## DISEÑO

### Arquitectura General
La arquitectura del sistema sigue un patrón cliente-servidor distribuido donde el ESP32 actúa como servidor de datos y la aplicación de escritorio como cliente para visualización y análisis:

**Capa de Hardware:**
- ESP32 DevKit V1 como unidad de procesamiento principal
- Sensor HC-SR04 para medición ultrasónica de distancia
- Conectividad WiFi para transmisión de datos
- Alimentación dual 5V/3.3V para compatibilidad de componentes

**Capa de Comunicación:**
- Protocolo TCP/IP sobre WiFi para transmisión robusta
- Puerto 8080 como canal de comunicación estándar
- Protocolo de aplicación custom: "MODO:DISTANCIA_ULTRA" para inicialización
- Formato de datos: "ULTRA_CM:<valor>" para transmisión de mediciones

**Capa de Aplicación:**
- Framework PySide6 para interfaz gráfica profesional
- Threading asíncrono (QThread) para operaciones no bloqueantes
- Matplotlib integrado para visualización científica
- Sistema de persistencia JSON para configuraciones

### Patrones de Diseño Implementados
- **Observer Pattern**: Señales Qt para comunicación entre componentes
- **Producer-Consumer**: Thread de comunicación produce datos, UI los consume
- **Strategy Pattern**: Diferentes estrategias de exportación (Excel/CSV)
- **Factory Pattern**: Creación dinámica de elementos de visualización

---

## IMPLEMENTACIÓN

### Componentes de Software Principal

**UltrasonicThread (Productor de Datos):**
```python
class UltrasonicThread(QThread):
    data = Signal(float, float)  # distancia_cm, dt_ms
    status = Signal(str)
    
    def run(self):
        # Establecimiento de conexión TCP
        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.sock.connect((self.esp32_ip, self.port))
        self.sock.sendall(b"MODO:DISTANCIA_ULTRA")
        
        # Loop de recepción continua
        while self._running:
            chunk = self.sock.recv(128)
            buffer += chunk.decode(errors="ignore")
            # Procesamiento de protocolo línea por línea
            while "\n" in buffer:
                line, buffer = buffer.split("\n", 1)
                if "ULTRA_CM:" in line:
                    dist = float(line.split(":")[1])
                    self.data.emit(dist, dt_ms)
```

**UltrasonicLogic (Controlador Principal):**
- Gestión del ciclo de vida del thread de comunicación
- Procesamiento y calibración de datos recibidos
- Actualización de elementos de interfaz gráfica
- Coordinación de exportación de datos

**Sistema de Calibración Lineal:**
```python
def calibrar(self, puntos):
    # Implementación de regresión lineal por mínimos cuadrados
    xs = [lectura for lectura, real in puntos]
    ys = [real for lectura, real in puntos]
    
    # Cálculo de pendiente y ordenada al origen
    mean_x, mean_y = sum(xs)/len(xs), sum(ys)/len(ys)
    numerador = sum((xs[i] - mean_x) * (ys[i] - mean_y) for i in range(len(xs)))
    denominador = sum((xs[i] - mean_x) ** 2 for i in range(len(xs)))
    
    m = numerador / denominador
    b = mean_y - m * mean_x
    
    # Ecuación final: distancia_real = m * lectura_sensor + b
    return m, b
```

### Protocolo de Comunicación
- **Inicialización**: Cliente envía "MODO:DISTANCIA_ULTRA", servidor responde "DISTANCIA_ULTRA_OK"
- **Transmisión**: Servidor envía continuamente "ULTRA_CM:<valor>\n"
- **Terminación**: Cliente envía "STOP", servidor cierra conexión gracefulmente

### Gestión de Datos en Tiempo Real
- Ventana deslizante de 200 muestras para eficiencia de memoria
- Cálculo automático de tiempo de respuesta entre mediciones
- Aplicación inmediata de calibración a datos entrantes
- Actualización gráfica optimizada con matplotlib

---

## FUNCIONES QUE TIENE EL SOFTWARE

### Funciones de Medición
1. **Conexión TCP Automática**: Establecimiento robusto de comunicación con ESP32
2. **Recepción Continua de Datos**: Procesamiento en tiempo real de mediciones ultrasónicas
3. **Cálculo de Tiempo de Respuesta**: Medición de latencia entre lecturas consecutivas
4. **Visualización Dual**: Presentación simultánea de datos crudos y calibrados

### Funciones de Calibración
1. **Calibración Asistida Multipunto**: Sistema interactivo para captura de puntos de referencia
2. **Regresión Lineal Automática**: Cálculo por mínimos cuadrados de ecuación de corrección
3. **Validación Visual**: Gráfica de dispersión con curva de ajuste para verificación
4. **Persistencia de Configuración**: Guardado automático de parámetros de calibración

### Funciones de Visualización
1. **Gráfica de Tendencias**: Representación temporal de distancia con líneas dual (cruda/calibrada)
2. **Indicadores Numéricos**: Displays digitales para distancia actual y tiempo de respuesta
3. **Estado de Calibración**: Indicador visual del estado de calibración del sistema
4. **Ventana Deslizante**: Optimización de rendimiento con buffer circular de muestras

### Funciones de Análisis y Exportación
1. **Exportación Excel Avanzada**: Generación de archivos .xlsx con múltiples hojas
   - Datos completos con timestamps
   - Metadatos del experimento
   - Información de calibración aplicada
   - Gráfica exportada como imagen integrada

2. **Exportación CSV**: Formato ligero para análisis en herramientas externas
3. **Generación de Reportes**: Inclusión automática de estadísticas descriptivas
4. **Preservación de Metadatos**: Información completa del contexto experimental

### Funciones de Control
1. **Inicio/Pausa de Monitoreo**: Control granular del proceso de medición
2. **Limpieza de Datos**: Reset de series manteniendo configuración de calibración
3. **Gestión de Conexiones**: Reconexión automática tras pérdida de red
4. **Validación de Entrada**: Verificación de parámetros antes de operaciones críticas

---

## VALIDACIÓN

### Pruebas de Funcionalidad Técnica
**Conectividad y Comunicación:**
- Validación de establecimiento TCP en tiempo < 5 segundos
- Verificación de parsing correcto del protocolo ULTRA_CM
- Pruebas de reconexión automática tras pérdida de red
- Confirmación de cierre graceful de conexiones

**Precisión de Medición:**
- Rango operativo validado: 5cm - 350cm con objetos sólidos
- Precisión absoluta: ±5mm en condiciones controladas
- Repetibilidad: Desviación estándar < 2mm en mediciones estáticas
- Linealidad: Error relativo < 1% en rango 20cm - 200cm

**Eficacia de Calibración:**
- Mejora de precisión > 80% post-calibración con 3+ puntos
- Validación de regresión lineal con R² > 0.95 en condiciones normales
- Persistencia correcta de parámetros entre sesiones
- Aplicación inmediata de corrección a datos entrantes

### Pruebas de Rendimiento
**Eficiencia de Sistema:**
- Uso de memoria RAM < 100MB durante operación normal
- Actualización de UI fluida a frecuencias > 10 FPS
- Ventana deslizante mantiene rendimiento constante en sesiones largas
- Tiempo de exportación < 10 segundos para archivos de 1000+ muestras

**Estabilidad Operacional:**
- Operación continua > 2 horas sin degradación de rendimiento
- Manejo robusto de excepciones de red y parsing
- Recuperación automática ante errores transitorios
- Liberación correcta de recursos al finalizar

### Pruebas de Usabilidad Educativa
**Facilidad de Uso:**
- Tiempo de aprendizaje < 15 minutos para operación básica
- Interfaz intuitiva sin necesidad de manual para funciones principales
- Retroalimentación visual clara del estado del sistema
- Mensajes de error informativos y orientados a solución

**Aplicabilidad Pedagógica:**
- Validación exitosa en cursos de física nivel secundaria
- Uso efectivo en laboratorios de instrumentación universitaria
- Adaptabilidad a diferentes niveles de complejidad conceptual
- Generación automática de material para reportes de laboratorio

---

## PLATAFORMA

### Hardware
**Microcontrolador Principal:**
- ESP32 DevKit V1 (Espressif Systems)
- Procesador: Dual-core Tensilica Xtensa LX6 @ 240MHz
- Memoria: 520KB SRAM, 4MB Flash
- Conectividad: WiFi 802.11 b/g/n, Bluetooth 4.2
- GPIO: 34 pines digitales, 18 canales ADC
- Alimentación: 5V vía USB o fuente externa

**Sensor de Distancia:**
- HC-SR04 Ultrasonic Distance Sensor
- Principio: Tiempo de vuelo ultrasónico
- Frecuencia: 40kHz
- Rango efectivo: 2cm - 400cm
- Precisión: ±3mm
- Ángulo de cobertura: 15 grados
- Corriente de operación: 15mA

**Infraestructura de Red:**
- Router WiFi 802.11n (mínimo)
- Ancho de banda: > 1Mbps para operación fluida
- Latencia de red: < 100ms para tiempo real óptimo
- Configuración recomendada: IP estática para ESP32

### Software
**Entorno de Desarrollo:**
- Python 3.8+ (CPython implementation)
- PySide6 6.0+ para interfaz gráfica Qt6
- matplotlib 3.5+ para visualización científica
- pandas 1.3+ para manipulación de datos estructurados
- openpyxl 3.0+ para exportación Excel nativa

**Sistema Operativo Soportado:**
- Windows 10/11 (x64) - Plataforma principal de desarrollo
- macOS 10.14+ (Intel/Apple Silicon) - Compatibilidad verificada
- Ubuntu 18.04+ LTS - Soporte para entornos académicos
- Distribuciones Linux compatibles con Qt6

**Firmware del Microcontrolador:**
- MicroPython v1.19+ con soporte para sockets
- Bibliotecas: machine, network, socket, time
- Configuración WiFi automática con credenciales embebidas
- Servidor TCP simple con protocol handling custom

**Dependencias del Sistema:**
- Controladores USB-Serial para ESP32 (CP210x/CH340)
- Bibliotecas gráficas del sistema para aceleración Qt
- Codecs de fuentes para renderizado de texto científico
- Permisos de red para comunicación TCP/IP

---

## AMBIENTE

### Entorno de Desarrollo
**Configuración del Workspace:**
- IDE recomendado: Visual Studio Code con extensiones Python
- Control de versiones: Git con repositorio estructurado por módulos
- Gestión de dependencias: pip con requirements.txt versionado
- Documentación: Markdown con diagramas ASCII para compatibilidad

**Flujo de Desarrollo:**
- Desarrollo modular con separación clara UI/Logic
- Testing automatizado con pytest para funciones críticas
- Integración continua con validación de dependencias
- Documentación técnica generada automáticamente

### Entorno de Despliegue Educativo
**Laboratorio Típico:**
- 10-20 estaciones de trabajo Windows/Linux
- Red local aislada para seguridad y control
- Fuentes de alimentación 5V estabilizadas
- Kit de componentes electrónicos básicos por estación

**Configuración de Red Educativa:**
- Segmento de red dedicado (192.168.x.0/24)
- DHCP con reservas para ESP32 conocidos
- Firewall configurado para permitir solo puerto 8080
- Monitoreo de tráfico para identificar problemas

### Entorno de Producción/Investigación
**Laboratorio de Investigación:**
- Estaciones de alta precisión con instrumentación calibrada
- Ambiente controlado de temperatura y humedad
- Patrones de distancia certificados para calibración
- Sistema de logging centralizado para trazabilidad

**Configuración Industrial:**
- Alimentación UPS para operación continua
- Red industrial con QoS garantizado
- Respaldo automático de configuraciones
- Monitoreo de salud del sistema 24/7

### Consideraciones Ambientales
**Condiciones Operativas:**
- Temperatura: 0°C a 40°C (sensor HC-SR04)
- Humedad relativa: 10% a 85% sin condensación
- Presión atmosférica: Nivel del mar a 3000m altitud
- Ruido electromagnético: Ambiente típico de laboratorio

**Factores que Afectan la Medición:**
- Temperatura del aire: Afecta velocidad del sonido
- Humedad: Influencia menor en propagación ultrasónica
- Corrientes de aire: Pueden causar fluctuaciones menores
- Superficies no perpendiculares: Reducen precisión de eco

---

**Documento Técnico | SENSORA ULTRASONIC | Versión 1.0**  
**Sistema de Medición de Distancia por Ultrasonido para Aplicaciones Educativas**  
**Desarrollado para SENSORA CORE - Plataforma de Sensores Didácticos**  
**Agosto 2025 | Documentación Técnica Completa**
