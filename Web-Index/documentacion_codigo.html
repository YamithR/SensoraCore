<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SensoraCore - Documentaci√≥n de C√≥digo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .hero h1 {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .hero .subtitle {
            font-size: 1.3em;
            font-weight: 300;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .back-link {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* Navigation */
        .navigation {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 15px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-btn {
            background: transparent;
            color: #667eea;
            border: 2px solid transparent;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin: 40px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 2.2em;
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .subsection-title {
            font-size: 1.6em;
            color: #764ba2;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-left: 15px;
            border-left: 4px solid #764ba2;
        }

        .description {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            color: #555;
            font-size: 1.05em;
        }

        .description h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .description ul {
            margin-left: 20px;
        }

        .description li {
            margin: 8px 0;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            overflow-x: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            position: relative;
        }

        .code-header {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            margin: -25px -25px 15px -25px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        .language-tag {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            backdrop-filter: blur(10px);
        }

        .copy-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .copy-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .copy-btn.copied {
            background: #28a745;
        }

        .copy-image-btn {
            background: #764ba2;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            margin-left: 5px;
        }

        .copy-image-btn:hover {
            background: #667eea;
        }

        .copy-image-btn.copied {
            background: #28a745;
        }

        pre {
            margin: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.5;
        }

        code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        /* Syntax highlighting colors */
        .keyword { color: #fc8181; font-weight: bold; }
        .function { color: #90cdf4; font-weight: bold; }
        .string { color: #9ae6b4; }
        .comment { color: #a0aec0; font-style: italic; }
        .number { color: #fbd38d; }
        .variable { color: #fbb6ce; }
        .class { color: #f6ad55; font-weight: bold; }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            color: #333;
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }
        
        .feature-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        
        .feature-card p {
            color: #666;
        }

        .feature-card h3 {
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .feature-card ul {
            list-style: none;
        }

        .feature-card li:before {
            content: "‚úì ";
            font-weight: bold;
            margin-right: 5px;
        }

        .info-box {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .info-box strong {
            color: #0c5460;
        }

        .info-box.success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .info-box.success strong {
            color: #155724;
        }

        .info-box.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        /* Estilos para controles de gr√°ficas */
        .graph-controls {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
        }

        .control-group select,
        .control-group input,
        .control-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-group select:focus,
        .control-group input:focus,
        .control-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .control-group textarea {
            font-family: 'Courier New', monospace;
            min-height: 80px;
            resize: vertical;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-primary,
        .btn-secondary {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e1e8ed;
            color: #2c3e50;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .graph-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-top: 20px;
            min-height: 500px;
        }

        .scale-toggle {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .scale-toggle label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 13px;
        }

        .scale-toggle input[type="checkbox"] {
            width: auto;
        }

        footer {
            background: #2d3748;
            color: white;
            text-align: center;
            padding: 30px 20px;
            margin-top: 40px;
            border-radius: 15px;
        }
        
        footer p {
            color: #cbd5e0;
            margin-bottom: 10px;
        }
        
        footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        footer a:hover {
            color: #764ba2;
        }

        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 5px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .badge.firmware {
            background: rgba(252, 129, 129, 0.3);
        }

        .badge.desktop {
            background: rgba(154, 230, 180, 0.3);
        }

        .badge.protocol {
            background: rgba(251, 179, 141, 0.3);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2em;
            }
            
            .hero .subtitle {
                font-size: 1.1em;
            }

            .section-title {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
                margin: 20px 10px;
            }

            .navigation {
                flex-direction: column;
            }

            .nav-btn {
                width: 100%;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }
        
        /* Inline code */
        :not(pre) > code {
            background: #f7fafc;
            color: #667eea;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero">
        <h1>üìö Documentaci√≥n de C√≥digo</h1>
        <p class="subtitle">SensoraCore Beta 1.0 - Gu√≠a T√©cnica Completa</p>
        <div style="margin-top: 20px;">
            <span class="badge firmware">Firmware MicroPython</span>
            <span class="badge desktop">App Desktop PySide6</span>
            <span class="badge protocol">Protocolo TCP/IP</span>
        </div>
        <a href="../index.html" class="back-link" style="margin-top: 20px;">‚Üê Volver al Inicio</a>
    </div>

    <div class="container">
        <nav class="navigation">
            <button class="nav-btn active" onclick="showSection('overview')">üìã Resumen General</button>
            <button class="nav-btn" onclick="showSection('firmware')">‚ö° Firmware Embebido</button>
            <button class="nav-btn" onclick="showSection('desktop')">üñ•Ô∏è App Desktop</button>
            <button class="nav-btn" onclick="showSection('communication')">üîó Comunicaci√≥n</button>
            <button class="nav-btn" onclick="showSection('calibration')">üéØ Calibraci√≥n</button>
            <button class="nav-btn" onclick="showSection('graphs')">üìä Gr√°ficas Interactivas</button>
        </nav>

        <div class="content">
            <!-- SECCI√ìN: RESUMEN GENERAL -->
            <section id="overview" class="section active">
                <h2 class="section-title">üìã Resumen General del Sistema</h2>
                
                <div class="description">
                    <h3>üéØ Descripci√≥n del Proyecto</h3>
                    <p>SensoraCore es un sistema completo de monitoreo de sensores basado en ESP32 con MicroPython, que proporciona una soluci√≥n integrada para la adquisici√≥n, procesamiento y visualizaci√≥n de datos de m√∫ltiples tipos de sensores.</p>
                </div>

                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>‚ö° Firmware Embebido</h3>
                        <ul>
                            <li>MicroPython en ESP32</li>
                            <li>11 m√≥dulos de sensores</li>
                            <li>Servidor TCP/IP integrado</li>
                            <li>Calibraci√≥n en tiempo real</li>
                            <li>Pantalla OLED informativa</li>
                        </ul>
                    </div>

                    <div class="feature-card">
                        <h3>üñ•Ô∏è Aplicaci√≥n Desktop</h3>
                        <ul>
                            <li>PySide6 (Qt for Python)</li>
                            <li>Interfaz gr√°fica intuitiva</li>
                            <li>Gr√°ficos en tiempo real</li>
                            <li>Exportaci√≥n Excel/CSV</li>
                            <li>Calibraci√≥n asistida</li>
                        </ul>
                    </div>

                    <div class="feature-card">
                        <h3>üîó Comunicaci√≥n</h3>
                        <ul>
                            <li>Protocolo TCP/IP WiFi</li>
                            <li>Puerto 8080</li>
                            <li>Comandos ASCII simples</li>
                            <li>Stream de datos continuo</li>
                            <li>Baja latencia</li>
                        </ul>
                    </div>
                </div>

                <h3 class="subsection-title">üìä M√≥dulos de Sensores Soportados</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div class="info-box">
                        <strong>üéöÔ∏è √Ångulo Simple</strong><br>
                        Potenci√≥metro √∫nico (-135¬∞ a +135¬∞)
                    </div>
                    <div class="info-box">
                        <strong>ü¶æ Brazo Rob√≥tico</strong><br>
                        3 potenci√≥metros + sensor capacitivo
                    </div>
                    <div class="info-box">
                        <strong>üì° Infrarrojo/Capacitivo</strong><br>
                        Sensores de proximidad digitales
                    </div>
                    <div class="info-box">
                        <strong>üìè Ultras√≥nico HC-SR04</strong><br>
                        Medici√≥n de distancia por ultrasonido
                    </div>
                    <div class="info-box">
                        <strong>üöó Velocidad √ìptica</strong><br>
                        RPM con encoders √≥pticos
                    </div>
                    <div class="info-box">
                        <strong>üéÆ Direcci√≥n IR</strong><br>
                        Control PID con 5 sensores IR
                    </div>
                    <div class="info-box">
                        <strong>üå°Ô∏è Termorregulaci√≥n</strong><br>
                        LM35, DS18B20, Termopar K
                    </div>
                    <div class="info-box">
                        <strong>üí® Gases MQ</strong><br>
                        MQ2 (humo/LPG), MQ3 (alcohol)
                    </div>
                    <div class="info-box">
                        <strong>üí° Brillo LDR</strong><br>
                        Fotoresistencia con calibraci√≥n
                    </div>
                    <div class="info-box">
                        <strong>üé® Color CNY70</strong><br>
                        Sensor reflectivo de color
                    </div>
                    <div class="info-box">
                        <strong>üåà Color TCS3200</strong><br>
                        Sensor RGB de frecuencia
                    </div>
                </div>

                <div class="info-box success">
                    <strong>‚úÖ Caracter√≠sticas Principales:</strong>
                    <ul style="margin-top: 10px;">
                        <li>Modularidad: Cada sensor es un m√≥dulo independiente</li>
                        <li>Escalabilidad: F√°cil agregar nuevos sensores</li>
                        <li>Persistencia: Calibraciones guardadas en JSON</li>
                        <li>Robustez: Manejo de errores y reconexi√≥n autom√°tica</li>
                        <li>Visualizaci√≥n: Gr√°ficos matplotlib embebidos en Qt</li>
                    </ul>
                </div>
            </section>

            <!-- SECCI√ìN: FIRMWARE EMBEBIDO -->
            <section id="firmware" class="section">
                <h2 class="section-title">‚ö° Firmware Embebido (MicroPython)</h2>
                
                <div class="description">
                    <h3>üìù Descripci√≥n General</h3>
                    <p><strong>Lenguaje y entorno:</strong> Implementado en MicroPython por su ligereza y compatibilidad con microcontroladores, permitiendo programaci√≥n modular y r√°pida iteraci√≥n.</p>
                    
                    <h3 style="margin-top: 15px;">üéØ Funciones Principales:</h3>
                    <ul>
                        <li><strong>Lectura de sensores:</strong> Conversi√≥n anal√≥gica-digital (ADC) para sensores como LM35 y MQ2; manejo de protocolos digitales (OneWire para DS18B20, SPI para MAX6675, I¬≤C para TCS3200).</li>
                        <li><strong>Preprocesamiento:</strong> Filtrado b√°sico de se√±ales, compensaci√≥n t√©rmica (ej. HC-SR04) y normalizaci√≥n de datos.</li>
                        <li><strong>Calibraci√≥n embebida:</strong> Aplicaci√≥n de algoritmos de regresi√≥n lineal, polin√≥mica y logar√≠tmica seg√∫n el tipo de sensor.</li>
                        <li><strong>Comunicaci√≥n:</strong> Transmisi√≥n de datos mediante protocolo TCP/IP sobre Wi-Fi, asegurando estabilidad y baja latencia.</li>
                    </ul>
                    
                    <h3 style="margin-top: 15px;">üèóÔ∏è Estructura Modular:</h3>
                    <p>Scripts dedicados por tipo de sensor (<code>main_parte1_distancia_angulo.py</code>, <code>main_parte3_gases_temperatura.py</code>, etc.), facilitando la escalabilidad y mantenimiento.</p>
                </div>

                <h3 class="subsection-title">1Ô∏è‚É£ Conexi√≥n WiFi y Servidor TCP</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">MicroPython</span>
                            <span>Funci√≥n: connect_wifi() - Conexi√≥n WiFi con reintentos</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">connect_wifi</span>():
    <span class="string">"""Conecta al WiFi con reintentos y manejo de errores"""</span>
    <span class="function">print</span>(<span class="string">"\n[WiFi] Iniciando conexi√≥n..."</span>)
    sta = network.WLAN(network.STA_IF)
    
    sta.active(<span class="keyword">False</span>)
    time.sleep(<span class="number">1</span>)
    sta.active(<span class="keyword">True</span>)
    
    max_attempts = <span class="number">5</span>
    
    <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="function">range</span>(<span class="number">1</span>, max_attempts + <span class="number">1</span>):
        <span class="keyword">try</span>:
            <span class="function">print</span>(<span class="string">f"[WiFi] Intento {attempt}/{max_attempts}: Conectando a '{SSID}'..."</span>)
            oled_write(<span class="string">"SensoraCore"</span>, <span class="string">"WiFi..."</span>, <span class="string">f"Intento {attempt}/5"</span>, <span class="string">""</span>, <span class="string">""</span>)
            
            <span class="keyword">if</span> sta.isconnected():
                sta.disconnect()
                time.sleep(<span class="number">1</span>)
            
            sta.connect(SSID, PASSWORD)
            
            timeout = <span class="number">15</span>
            start_time = time.time()
            
            <span class="keyword">while</span> <span class="keyword">not</span> sta.isconnected() <span class="keyword">and</span> (time.time() - start_time) &lt; timeout:
                time.sleep(<span class="number">0.5</span>)
                led.value(<span class="keyword">not</span> led.value())  <span class="comment"># Parpadeo indicador</span>
            
            <span class="keyword">if</span> sta.isconnected():
                led.value(<span class="number">1</span>)
                ip = sta.ifconfig()[<span class="number">0</span>]
                <span class="function">print</span>(<span class="string">f"[WiFi] ‚úì Conectado: {ip}"</span>)
                oled_write(<span class="string">"WiFi OK!"</span>, ip, <span class="string">""</span>, <span class="string">"Servidor"</span>, <span class="string">"iniciando..."</span>)
                time.sleep(<span class="number">2</span>)
                <span class="keyword">return</span> sta
            <span class="keyword">else</span>:
                <span class="function">print</span>(<span class="string">f"[WiFi] ‚úó Timeout en intento {attempt}"</span>)
                
        <span class="keyword">except</span> OSError <span class="keyword">as</span> e:
            <span class="function">print</span>(<span class="string">f"[WiFi] ‚úó Error OSError: {e}"</span>)
        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
            <span class="function">print</span>(<span class="string">f"[WiFi] ‚úó Error: {e}"</span>)
        
        <span class="keyword">if</span> attempt &lt; max_attempts:
            time.sleep(<span class="number">2</span>)
    
    <span class="function">print</span>(<span class="string">"[WiFi] ‚úó‚úó‚úó ERROR CR√çTICO: No se pudo conectar"</span>)
    oled_write(<span class="string">"ERROR WiFi"</span>, <span class="string">"No conectado"</span>, <span class="string">""</span>, <span class="string">"Reiniciando..."</span>, <span class="string">""</span>)
    time.sleep(<span class="number">3</span>)
    <span class="keyword">return</span> <span class="keyword">None</span></code></pre>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">MicroPython</span>
                            <span>Funci√≥n: create_server() - Creaci√≥n del servidor TCP</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">create_server</span>():
    <span class="string">"""Crea el servidor TCP en el puerto 8080"""</span>
    <span class="keyword">try</span>:
        addr = socket.getaddrinfo(<span class="string">'0.0.0.0'</span>, <span class="number">8080</span>)[<span class="number">0</span>][-<span class="number">1</span>]
        s = socket.socket()
        s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)
        s.bind(addr)
        s.listen(<span class="number">1</span>)  <span class="comment"># Acepta 1 conexi√≥n a la vez</span>
        
        <span class="function">print</span>(<span class="string">f"\n[Servidor] ‚úì Iniciado en puerto 8080"</span>)
        <span class="function">print</span>(<span class="string">f"[Servidor] IP: {sta.ifconfig()[0]}:8080"</span>)
        <span class="keyword">return</span> s
        
    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
        <span class="function">print</span>(<span class="string">f"[Servidor] ‚úó Error: {e}"</span>)
        <span class="keyword">return</span> <span class="keyword">None</span>

<span class="comment"># Bucle principal de escucha</span>
<span class="keyword">while</span> <span class="keyword">True</span>:
    <span class="keyword">try</span>:
        client, addr = server.accept()
        <span class="function">print</span>(<span class="string">f'\n[Servidor] ‚úì Cliente conectado: {addr}'</span>)
        
        client.settimeout(<span class="number">30</span>)
        data = client.recv(<span class="number">1024</span>).decode().strip()
        <span class="function">print</span>(<span class="string">f'[Servidor] Comando: {data}'</span>)
        
        <span class="comment"># Procesar comandos MODO:XXXX</span>
        <span class="keyword">if</span> <span class="string">'MODO:ANGULO_SIMPLE'</span> <span class="keyword">in</span> data:
            current_mode = <span class="string">'ANGULO_SIMPLE'</span>
            client.sendall(<span class="string">b"ANGULO_SIMPLE_OK\n"</span>)
            angulo_simple_loop(client)
            
    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
        <span class="function">print</span>(<span class="string">f"[Servidor] Error: {e}"</span>)</code></pre>
                </div>

                <h3 class="subsection-title">2Ô∏è‚É£ Lectura de Sensores Anal√≥gicos (ADC)</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">MicroPython</span>
                            <span>Funci√≥n: read_adc_filtered() - Lectura ADC con filtrado</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">read_adc_filtered</span>(adc_obj, samples=<span class="number">5</span>):
    <span class="string">"""Lee el ADC con promedio de m√∫ltiples muestras para reducir ruido
    
    Par√°metros:
        adc_obj: Objeto ADC configurado
        samples: N√∫mero de muestras a promediar (default: 5)
    
    Retorna:
        int: Valor promediado del ADC (0-4095 para 12 bits)
    """</span>
    total = <span class="number">0</span>
    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="function">range</span>(samples):
        total += adc_obj.read()
        time.sleep_ms(<span class="number">1</span>)  <span class="comment"># Peque√±a pausa entre lecturas</span>
    
    <span class="keyword">return</span> total // samples  <span class="comment"># Divisi√≥n entera para promedio</span>

<span class="comment"># Ejemplo de uso con mapeo a rango f√≠sico</span>
<span class="keyword">def</span> <span class="function">map_value</span>(value, in_min, in_max, out_min, out_max):
    <span class="string">"""Mapea un valor de un rango a otro"""</span>
    <span class="keyword">return</span> <span class="function">int</span>((value - in_min) * (out_max - out_min) / (in_max - in_min) + out_min)

<span class="comment"># Uso: Convertir ADC (0-4095) a √°ngulo (-135¬∞ a +135¬∞)</span>
lectura = read_adc_filtered(pot_simple, samples=<span class="number">3</span>)
angulo = map_value(lectura, <span class="number">0</span>, <span class="number">4095</span>, -<span class="number">135</span>, <span class="number">135</span>)</code></pre>
                </div>

                <h3 class="subsection-title">3Ô∏è‚É£ Sensor de Temperatura LM35</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">MicroPython</span>
                            <span>Funci√≥n: read_lm35() - Lectura de temperatura anal√≥gica</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">read_lm35</span>():
    <span class="string">"""Lee LM35 con compensaci√≥n de no-linealidad del ADC ESP32
    NOTA: LM35 alimentado a 5V, pero ADC ESP32 lee m√°ximo 3.3V
    """</span>
    <span class="keyword">if</span> lm35_adc <span class="keyword">is</span> <span class="keyword">None</span>:
        <span class="keyword">return</span> -<span class="number">999</span>
    <span class="keyword">try</span>:
        <span class="comment"># Promediar m√∫ltiples lecturas para estabilidad</span>
        raw = read_adc_filtered(lm35_adc, samples=<span class="number">20</span>)
        
        <span class="comment"># Compensaci√≥n de no-linealidad del ADC ESP32</span>
        <span class="comment"># El ADC ESP32 es no-lineal en los extremos (0-150mV y 3150-3300mV)</span>
        <span class="comment"># Rango √∫til: 150mV - 3150mV (aprox 150-4000 ADC)</span>
        
        <span class="comment"># IMPORTANTE: ADC ESP32 lee m√°ximo 3.3V aunque LM35 est√© a 5V</span>
        <span class="comment"># LM35 con Vcc=5V puede dar hasta 1.5V (150¬∞C)</span>
        voltage = (raw / <span class="number">4095.0</span>) * <span class="number">3.3</span>
        
        <span class="comment"># LM35: 10mV/¬∞C (0.01V/¬∞C) sin importar Vcc</span>
        <span class="comment"># La salida es proporcional a temperatura, no a Vcc</span>
        <span class="comment"># F√≥rmula: Temp(¬∞C) = Voltage(V) √ó 100</span>
        temp_c = voltage * <span class="number">100.0</span>
        
        <span class="comment"># Validar rango f√≠sico del LM35</span>
        <span class="comment"># Rango medible: 0¬∞C a 150¬∞C (0V a 1.5V)</span>
        <span class="keyword">if</span> temp_c &lt; -<span class="number">10</span> <span class="keyword">or</span> temp_c &gt; <span class="number">150</span>:
            <span class="keyword">return</span> -<span class="number">999</span>
        
        <span class="keyword">return</span> <span class="function">round</span>(temp_c, <span class="number">2</span>)
    <span class="keyword">except</span> <span class="function">Exception</span> <span class="keyword">as</span> e:
        <span class="function">print</span>(<span class="string">f"[LM35] Error lectura: {e}"</span>)
        <span class="keyword">return</span> -<span class="number">999</span></code></pre>
                </div>

                <h3 class="subsection-title">4Ô∏è‚É£ Sensor Digital OneWire DS18B20</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">MicroPython</span>
                            <span>Funci√≥n: read_ds18b20() - Temperatura digital OneWire</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">read_ds18b20</span>():
    <span class="string">"""Lee DS18B20 digital con protocolo OneWire"""</span>
    <span class="keyword">if</span> ds_sensor <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> ds_rom <span class="keyword">is</span> <span class="keyword">None</span>:
        <span class="keyword">return</span> -<span class="number">999</span>
    <span class="keyword">try</span>:
        <span class="comment"># Iniciar conversi√≥n de temperatura</span>
        ds_sensor.convert_temp()
        
        <span class="comment"># Esperar tiempo de conversi√≥n seg√∫n resoluci√≥n:</span>
        <span class="comment"># 9-bit: 93.75ms, 10-bit: 187.5ms, 11-bit: 375ms, 12-bit: 750ms</span>
        <span class="comment"># Por defecto usa 12-bit (m√°xima precisi√≥n: 0.0625¬∞C)</span>
        time.sleep_ms(<span class="number">750</span>)
        
        <span class="comment"># Leer temperatura</span>
        temp_c = ds_sensor.read_temp(ds_rom)
        
        <span class="comment"># Validar rango DS18B20 (-55¬∞C a +125¬∞C)</span>
        <span class="keyword">if</span> temp_c &lt; -<span class="number">55</span> <span class="keyword">or</span> temp_c &gt; <span class="number">125</span>:
            <span class="function">print</span>(<span class="string">f"[DS18B20] Temp fuera de rango: {temp_c}¬∞C"</span>)
            <span class="keyword">return</span> -<span class="number">999</span>
        
        <span class="comment"># Verificar lectura v√°lida (DS18B20 devuelve 85¬∞C si hay error)</span>
        <span class="keyword">if</span> temp_c == <span class="number">85.0</span>:
            <span class="function">print</span>(<span class="string">"[DS18B20] Lectura de error (85¬∞C) - sensor no listo"</span>)
            <span class="keyword">return</span> -<span class="number">999</span>
        
        <span class="keyword">return</span> <span class="function">round</span>(temp_c, <span class="number">2</span>)
    <span class="keyword">except</span> <span class="function">OSError</span> <span class="keyword">as</span> e:
        <span class="function">print</span>(<span class="string">f"[DS18B20] Error OneWire: {e}"</span>)
        <span class="keyword">return</span> -<span class="number">999</span>
    <span class="keyword">except</span> <span class="function">Exception</span> <span class="keyword">as</span> e:
        <span class="function">print</span>(<span class="string">f"[DS18B20] Error lectura: {e}"</span>)
        <span class="keyword">return</span> -<span class="number">999</span></code></pre>
                </div>

                <h3 class="subsection-title">5Ô∏è‚É£ Sensor SPI MAX6675 (Termopar)</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">MicroPython</span>
                            <span>Funci√≥n: read_max6675() - Lectura termopar tipo K via SPI</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">read_max6675</span>():
    <span class="string">"""Lee MAX6675 (termopar Type-K) v√≠a SPI"""</span>
    <span class="keyword">if</span> spi <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> cs <span class="keyword">is</span> <span class="keyword">None</span>:
        <span class="keyword">return</span> -<span class="number">999</span>
    
    <span class="keyword">try</span>:
        <span class="comment"># Activar chip (CS LOW)</span>
        cs.value(<span class="number">0</span>)
        time.sleep_us(<span class="number">1</span>)  <span class="comment"># Tiempo de setup</span>
        
        <span class="comment"># Leer 2 bytes (16 bits) del MAX6675</span>
        data = spi.read(<span class="number">2</span>)
        
        <span class="comment"># Desactivar chip (CS HIGH)</span>
        cs.value(<span class="number">1</span>)
        
        <span class="keyword">if</span> <span class="function">len</span>(data) != <span class="number">2</span>:
            <span class="function">print</span>(<span class="string">"[MAX6675] Error: datos incompletos"</span>)
            <span class="keyword">return</span> -<span class="number">999</span>
        
        <span class="comment"># Combinar bytes (MSB primero)</span>
        raw = (data[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">1</span>]
        
        <span class="comment"># Verificar bit D2 (termopar desconectado)</span>
        <span class="keyword">if</span> raw &amp; <span class="number">0x0004</span>:
            <span class="function">print</span>(<span class="string">"[MAX6675] ERROR: Termopar desconectado"</span>)
            <span class="keyword">return</span> -<span class="number">999</span>
        
        <span class="comment"># Verificar bit 0 (debe ser 0 para MAX6675 v√°lido)</span>
        <span class="keyword">if</span> raw &amp; <span class="number">0x0001</span>:
            <span class="function">print</span>(<span class="string">"[MAX6675] ERROR: Bit de ID inv√°lido"</span>)
            <span class="keyword">return</span> -<span class="number">999</span>
        
        <span class="comment"># Extraer temperatura: bits [14:3] = 12 bits</span>
        temp_bits = (raw &gt;&gt; <span class="number">3</span>) &amp; <span class="number">0x0FFF</span>
        
        <span class="comment"># Conversi√≥n: cada bit = 0.25¬∞C (resoluci√≥n 12-bit)</span>
        temp_c = temp_bits * <span class="number">0.25</span>
        
        <span class="comment"># Validar rango MAX6675 (0¬∞C a +1024¬∞C)</span>
        <span class="keyword">if</span> temp_c &lt; <span class="number">0</span> <span class="keyword">or</span> temp_c &gt; <span class="number">1024</span>:
            <span class="function">print</span>(<span class="string">f"[MAX6675] Temp fuera de rango: {temp_c}¬∞C"</span>)
            <span class="keyword">return</span> -<span class="number">999</span>
        
        <span class="keyword">return</span> <span class="function">round</span>(temp_c, <span class="number">2</span>)
        
    <span class="keyword">except</span> <span class="function">Exception</span> <span class="keyword">as</span> e:
        <span class="function">print</span>(<span class="string">f"[MAX6675] Error lectura SPI: {e}"</span>)
        <span class="keyword">return</span> -<span class="number">999</span></code></pre>
                </div>

                <h3 class="subsection-title">6Ô∏è‚É£ Sensor de Gases MQ (MQ2/MQ3)</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">MicroPython</span>
                            <span>Funci√≥n: read_mq_sensor() - C√°lculo PPM con curva logar√≠tmica</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">read_mq_sensor</span>(adc, sensor_name, samples=<span class="number">20</span>, R0=<span class="keyword">None</span>, RL=<span class="number">10000.0</span>):
    <span class="string">"""
    Lectura filtrada de sensor MQ con algoritmo PPM real basado en Rs/R0
    
    Par√°metros:
    - adc: ADC configurado
    - sensor_name: 'MQ2' o 'MQ3'
    - samples: muestras para promedio (default 20)
    - R0: Resistencia del sensor en aire limpio (calibraci√≥n)
    - RL: Resistencia de carga en el m√≥dulo (t√≠picamente 10kŒ©)
    
    Retorna: (raw, voltage, Rs, ppm) o None si hay error
    """</span>
    <span class="keyword">if</span> <span class="keyword">not</span> adc:
        <span class="keyword">return</span> <span class="keyword">None</span>
    
    <span class="keyword">try</span>:
        raw = read_adc_filtered(adc, samples=samples)
        
        <span class="comment"># Voltaje de salida del sensor (0-3.3V)</span>
        voltage = (raw / <span class="number">4095.0</span>) * <span class="number">3.3</span>
        
        <span class="comment"># Protecci√≥n contra divisi√≥n por cero</span>
        <span class="keyword">if</span> voltage &lt; <span class="number">0.01</span>:
            voltage = <span class="number">0.01</span>
        
        <span class="comment"># Calcular Rs (resistencia del sensor)
        # Vcc = 5V (alimentaci√≥n del sensor)
        # Formula: Rs = RL * (Vcc - Vout) / Vout</span>
        Vcc = <span class="number">5.0</span>
        Rs = RL * (Vcc - voltage) / voltage
        
        <span class="comment"># Valores R0 por defecto si no hay calibraci√≥n</span>
        <span class="keyword">if</span> R0 <span class="keyword">is</span> <span class="keyword">None</span>:
            <span class="keyword">if</span> sensor_name == <span class="string">'MQ2'</span>:
                R0 = <span class="number">10000.0</span>  <span class="comment"># Valor t√≠pico del datasheet</span>
            <span class="keyword">elif</span> sensor_name == <span class="string">'MQ3'</span>:
                R0 = <span class="number">60000.0</span>  <span class="comment"># Valor t√≠pico del datasheet</span>
            <span class="keyword">else</span>:
                R0 = <span class="number">10000.0</span>
        
        <span class="comment"># Calcular ratio Rs/R0</span>
        ratio = Rs / R0
        
        <span class="comment"># Curvas caracter√≠sticas logar√≠tmicas del datasheet
        # Ecuaci√≥n: log10(PPM) = m * log10(Rs/R0) + b</span>
        
        <span class="keyword">if</span> sensor_name == <span class="string">'MQ2'</span>:
            <span class="comment"># MQ2 - Curva H2: m = -0.45, b = 2.3 (200-10000 PPM)</span>
            m = -<span class="number">0.45</span>
            b = <span class="number">2.3</span>
            ppm_min, ppm_max = <span class="number">200.0</span>, <span class="number">10000.0</span>
        <span class="keyword">elif</span> sensor_name == <span class="string">'MQ3'</span>:
            <span class="comment"># MQ3 - Curva alcohol: m = -0.36, b = 2.0 (25-500 PPM)</span>
            m = -<span class="number">0.36</span>
            b = <span class="number">2.0</span>
            ppm_min, ppm_max = <span class="number">25.0</span>, <span class="number">500.0</span>
        <span class="keyword">else</span>:
            ppm = <span class="number">0.0</span>
        
        <span class="keyword">if</span> ratio &lt;= <span class="number">0</span>:
            ppm = ppm_min
        <span class="keyword">else</span>:
            <span class="keyword">import</span> math
            log_ratio = math.log10(ratio)
            log_ppm = m * log_ratio + b
            ppm = <span class="number">10</span> ** log_ppm
            <span class="keyword">if</span> ppm &lt; ppm_min:
                ppm = ppm_min
            <span class="keyword">elif</span> ppm &gt; ppm_max:
                ppm = ppm_max
        
        <span class="keyword">return</span> (raw, voltage, Rs, ppm)
    
    <span class="keyword">except</span> <span class="function">Exception</span> <span class="keyword">as</span> e:
        <span class="function">print</span>(<span class="string">f"[{sensor_name}] Error: {e}"</span>)
        <span class="keyword">return</span> <span class="keyword">None</span></code></pre>
                </div>

                <h3 class="subsection-title">7Ô∏è‚É£ Sensor Ultras√≥nico HC-SR04</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">MicroPython</span>
                            <span>Funci√≥n: distancia_ultrasonico_loop() - Medici√≥n por pulsos</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">distancia_ultrasonico_loop</span>(client):
    <span class="string">"""Loop del m√≥dulo HC-SR04 con c√°lculo de distancia"""</span>
    <span class="keyword">while</span> current_mode == <span class="string">'DISTANCIA_ULTRA'</span>:
        <span class="comment"># Generar pulso trigger (10Œºs)</span>
        trigger_pin.off()
        time.sleep_us(<span class="number">2</span>)
        trigger_pin.on()
        time.sleep_us(<span class="number">10</span>)
        trigger_pin.off()
        
        <span class="comment"># Medir tiempo de echo con timeout (30ms)</span>
        timeout_us = <span class="number">30000</span>
        
        <span class="comment"># Esperar inicio de echo</span>
        start_time = time.ticks_us()
        timeout_start = start_time
        <span class="keyword">while</span> echo_pin.value() == <span class="number">0</span>:
            start_time = time.ticks_us()
            <span class="keyword">if</span> time.ticks_diff(start_time, timeout_start) &gt; timeout_us:
                <span class="keyword">break</span>
        
        <span class="comment"># Medir duraci√≥n del echo</span>
        end_time = start_time
        <span class="keyword">while</span> echo_pin.value() == <span class="number">1</span>:
            end_time = time.ticks_us()
            <span class="keyword">if</span> time.ticks_diff(end_time, start_time) &gt; timeout_us:
                <span class="keyword">break</span>
        
        <span class="comment"># Calcular distancia</span>
        duration = time.ticks_diff(end_time, start_time)
        
        <span class="keyword">if</span> <span class="number">0</span> &lt; duration &lt; timeout_us:
            <span class="comment"># Velocidad del sonido: 343 m/s = 0.0343 cm/Œºs
            # Distancia = (tiempo √ó velocidad) / 2</span>
            distancia_cm = (duration * <span class="number">0.0343</span>) / <span class="number">2</span>
        <span class="keyword">else</span>:
            distancia_cm = -<span class="number">1</span>  <span class="comment"># Error o fuera de rango</span>
        
        <span class="comment"># Actualizar OLED</span>
        <span class="keyword">if</span> distancia_cm &gt;= <span class="number">0</span>:
            oled_write(<span class="string">"Ultrasonic"</span>, <span class="string">"-" * 16</span>, <span class="string">f"Dist: {distancia_cm:.1f}cm"</span>, <span class="string">""</span>, <span class="string">""</span>)
        <span class="keyword">else</span>:
            oled_write(<span class="string">"Ultrasonic"</span>, <span class="string">"-" * 16</span>, <span class="string">"Fuera rango"</span>, <span class="string">""</span>, <span class="string">""</span>)
        
        <span class="comment"># Enviar datos</span>
        msg = <span class="string">f"ULTRA_CM:{distancia_cm:.1f}\n"</span>
        client.sendall(msg.encode())
        
        time.sleep(<span class="number">0.06</span>)  <span class="comment"># ~16 Hz</span></code></pre>
                </div>

                <h3 class="subsection-title">8Ô∏è‚É£ Sensor de Color TCS3200</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">MicroPython</span>
                            <span>Funci√≥n: measure_pulse_width() - Medici√≥n RGB por frecuencia</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">select_filter</span>(color):
    <span class="string">"""Selecciona filtro de color: RED, GREEN, BLUE, CLEAR"""</span>
    <span class="keyword">if</span> color == <span class="string">'RED'</span>:
        s2.value(<span class="number">0</span>)
        s3.value(<span class="number">0</span>)
    <span class="keyword">elif</span> color == <span class="string">'GREEN'</span>:
        s2.value(<span class="number">1</span>)
        s3.value(<span class="number">1</span>)
    <span class="keyword">elif</span> color == <span class="string">'BLUE'</span>:
        s2.value(<span class="number">0</span>)
        s3.value(<span class="number">1</span>)
    <span class="keyword">else</span>:  <span class="comment"># CLEAR</span>
        s2.value(<span class="number">1</span>)
        s3.value(<span class="number">0</span>)

<span class="keyword">def</span> <span class="function">time_pulse_us</span>(pin, level, timeout_us):
    <span class="string">"""Mide duraci√≥n de pulso (similar a pulseIn de Arduino)"""</span>
    start = time.ticks_us()
    <span class="comment"># Esperar nivel opuesto</span>
    <span class="keyword">while</span> pin.value() == level:
        <span class="keyword">if</span> time.ticks_diff(time.ticks_us(), start) &gt; timeout_us:
            <span class="keyword">return</span> <span class="number">0</span>
    <span class="comment"># Esperar nivel deseado</span>
    <span class="keyword">while</span> pin.value() != level:
        <span class="keyword">if</span> time.ticks_diff(time.ticks_us(), start) &gt; timeout_us:
            <span class="keyword">return</span> <span class="number">0</span>
    <span class="comment"># Medir duraci√≥n</span>
    pulse_start = time.ticks_us()
    <span class="keyword">while</span> pin.value() == level:
        <span class="keyword">if</span> time.ticks_diff(time.ticks_us(), pulse_start) &gt; timeout_us:
            <span class="keyword">return</span> <span class="number">0</span>
    <span class="keyword">return</span> time.ticks_diff(time.ticks_us(), pulse_start)

<span class="keyword">def</span> <span class="function">measure_pulse_width</span>(color):
    <span class="string">"""Mide ancho de pulso para un color espec√≠fico"""</span>
    select_filter(color)
    time.sleep_ms(<span class="number">20</span>)  <span class="comment"># Estabilizaci√≥n</span>
    
    pulse_width = time_pulse_us(out_pin, <span class="number">0</span>, <span class="number">50000</span>)
    <span class="keyword">return</span> pulse_width <span class="keyword">if</span> pulse_width &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>

<span class="comment"># Uso en loop:</span>
pulse_red = measure_pulse_width(<span class="string">'RED'</span>)
pulse_green = measure_pulse_width(<span class="string">'GREEN'</span>)
pulse_blue = measure_pulse_width(<span class="string">'BLUE'</span>)

<span class="comment"># Convertir a frecuencias (Hz)</span>
freq_red = (<span class="number">1000000.0</span> / (<span class="number">2</span> * pulse_red)) <span class="keyword">if</span> pulse_red &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>
freq_green = (<span class="number">1000000.0</span> / (<span class="number">2</span> * pulse_green)) <span class="keyword">if</span> pulse_green &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>
freq_blue = (<span class="number">1000000.0</span> / (<span class="number">2</span> * pulse_blue)) <span class="keyword">if</span> pulse_blue &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>

<span class="comment"># Mapear a RGB 0-255 (menor frecuencia = m√°s color)</span>
red = map_value(<span class="function">int</span>(freq_red), R_MIN, R_MAX, <span class="number">255</span>, <span class="number">0</span>)
green = map_value(<span class="function">int</span>(freq_green), G_MIN, G_MAX, <span class="number">255</span>, <span class="number">0</span>)
blue = map_value(<span class="function">int</span>(freq_blue), B_MIN, B_MAX, <span class="number">255</span>, <span class="number">0</span>)</code></pre>
                </div>

                <div class="info-box warning">
                    <strong>‚ö†Ô∏è Nota Importante:</strong> Los sensores MQ requieren un per√≠odo de calentamiento de 20 segundos m√≠nimo (idealmente 24-48 horas para primera vez) para lecturas precisas.
                </div>
            </section>

            <!-- SECCI√ìN: APLICACI√ìN DESKTOP -->
            <section id="desktop" class="section">
                <h2 class="section-title">üñ•Ô∏è Aplicaci√≥n de Escritorio (Python + PySide6)</h2>
                
                <div class="description">
                    <h3>üé® Interfaz Gr√°fica (GUI)</h3>
                    <ul>
                        <li>Dise√±o intuitivo con pesta√±as por m√≥dulo (Temperatura, Gases, Distancia, etc.).</li>
                        <li>Visualizaci√≥n en tiempo real mediante gr√°ficos din√°micos (l√≠neas, barras y curvas de calibraci√≥n).</li>
                        <li>Panel de control para iniciar/terminar adquisici√≥n, aplicar calibraci√≥n y exportar datos.</li>
                    </ul>
                    
                    <h3 style="margin-top: 15px;">‚öôÔ∏è Funciones Avanzadas</h3>
                    <ul>
                        <li><strong>Exportaci√≥n de datos:</strong> Generaci√≥n de reportes en formato Excel (.xlsx) con metadatos (timestamp, tipo de sensor, valores calibrados).</li>
                        <li><strong>Calibraci√≥n asistida:</strong> Implementaci√≥n de algoritmos matem√°ticos (regresi√≥n lineal, polin√≥mica y logar√≠tmica) con ajuste autom√°tico de coeficientes.</li>
                        <li><strong>Gesti√≥n de conexi√≥n:</strong> Selecci√≥n de dispositivo ESP32 por IP, verificaci√≥n de estado y reconexi√≥n autom√°tica.</li>
                    </ul>
                    
                    <h3 style="margin-top: 15px;">üèóÔ∏è Arquitectura del Software</h3>
                    <ul>
                        <li><strong>M√≥dulo de comunicaci√≥n:</strong> Cliente TCP/IP para recepci√≥n de datos.</li>
                        <li><strong>M√≥dulo de visualizaci√≥n:</strong> Renderizado de gr√°ficos con matplotlib embebido en Qt.</li>
                        <li><strong>M√≥dulo de an√°lisis:</strong> Aplicaci√≥n de algoritmos y generaci√≥n de curvas de calibraci√≥n.</li>
                    </ul>
                </div>

                <h3 class="subsection-title">1Ô∏è‚É£ Cliente TCP para Comunicaci√≥n</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Python</span>
                            <span>Clase: AngleArmThread - Hilo de comunicaci√≥n TCP</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">from</span> PySide6.QtCore <span class="keyword">import</span> QThread, Signal
<span class="keyword">import</span> socket

<span class="keyword">class</span> <span class="class">AngleArmThread</span>(QThread):
    <span class="string">"""Thread para comunicaci√≥n TCP y procesamiento de datos en tiempo real"""</span>
    data_received = Signal(<span class="function">str</span>)
    connection_status = Signal(<span class="function">str</span>)
    
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="variable">self</span>, ip, port, parent=<span class="variable">None</span>):
        <span class="function">super</span>().__init__(parent)
        <span class="variable">self</span>.ip = ip
        <span class="variable">self</span>.port = port
        <span class="variable">self</span>.socket = <span class="variable">None</span>
        <span class="variable">self</span>.running = <span class="variable">False</span>
        <span class="variable">self</span>.buffer = <span class="string">""</span>
    
    <span class="keyword">def</span> <span class="function">run</span>(<span class="variable">self</span>):
        <span class="string">"""Bucle principal del thread"""</span>
        <span class="keyword">try</span>:
            <span class="variable">self</span>.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            <span class="variable">self</span>.socket.settimeout(<span class="number">5</span>)
            <span class="variable">self</span>.socket.connect((<span class="variable">self</span>.ip, <span class="variable">self</span>.port))
            <span class="variable">self</span>.connection_status.emit(<span class="string">"Conectado"</span>)
            <span class="variable">self</span>.running = <span class="variable">True</span>
            
            <span class="comment"># Enviar comando de cambio de modo</span>
            command = <span class="string">"MODO:ANGULO_BRAZO\n"</span>
            <span class="variable">self</span>.socket.sendall(command.encode(<span class="string">'utf-8'</span>))
            
            <span class="keyword">while</span> <span class="variable">self</span>.running:
                <span class="keyword">try</span>:
                    data = <span class="variable">self</span>.socket.recv(<span class="number">256</span>).decode(<span class="string">'utf-8'</span>)
                    <span class="keyword">if</span> <span class="keyword">not</span> data:
                        <span class="keyword">break</span>
                    
                    <span class="variable">self</span>.buffer += data
                    <span class="comment"># Procesar l√≠neas completas</span>
                    <span class="keyword">while</span> <span class="string">'\n'</span> <span class="keyword">in</span> <span class="variable">self</span>.buffer:
                        line, <span class="variable">self</span>.buffer = <span class="variable">self</span>.buffer.split(<span class="string">'\n'</span>, <span class="number">1</span>)
                        <span class="variable">self</span>.data_received.emit(line.strip())
                
                <span class="keyword">except</span> socket.timeout:
                    <span class="keyword">continue</span>
                <span class="keyword">except</span> <span class="function">Exception</span> <span class="keyword">as</span> e:
                    <span class="variable">self</span>.connection_status.emit(<span class="string">f"Error: {e}"</span>)
                    <span class="keyword">break</span>
        
        <span class="keyword">finally</span>:
            <span class="variable">self</span>.stop()
    
    <span class="keyword">def</span> <span class="function">stop</span>(<span class="variable">self</span>):
        <span class="string">"""Detiene el thread y cierra socket"""</span>
        <span class="variable">self</span>.running = <span class="variable">False</span>
        <span class="keyword">if</span> <span class="variable">self</span>.socket:
            <span class="variable">self</span>.socket.close()
        <span class="variable">self</span>.connection_status.emit(<span class="string">"Desconectado"</span>)</code></pre>
                </div>

                <h3 class="subsection-title">2Ô∏è‚É£ Calibraci√≥n Lineal (Regresi√≥n)</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Python</span>
                            <span>Funci√≥n: calibrar() - Calibraci√≥n por regresi√≥n lineal</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">import</span> numpy <span class="keyword">as</span> np
<span class="keyword">import</span> scipy.stats
<span class="keyword">from</span> PySide6.QtWidgets <span class="keyword">import</span> QMessageBox

<span class="keyword">def</span> <span class="function">calibrar</span>(<span class="variable">self</span>):
    <span class="string">"""Ejecuta calibraci√≥n lineal con los datos actuales (y = mx + b)"""</span>
    <span class="keyword">if</span> <span class="function">len</span>(<span class="variable">self</span>.raw_values) &lt; <span class="number">2</span>:
        QMessageBox.warning(<span class="variable">self</span>, <span class="string">"Error"</span>, <span class="string">"M√≠nimo 2 puntos requeridos"</span>)
        <span class="keyword">return</span>
    
    <span class="keyword">try</span>:
        x_data = np.array(<span class="variable">self</span>.raw_values)        <span class="comment"># Valores ADC crudos</span>
        y_data = np.array(<span class="variable">self</span>.actual_values)     <span class="comment"># Valores reales (calibrados)</span>
        
        <span class="comment"># Regresi√≥n lineal: y = slope*x + intercept</span>
        <span class="variable">self</span>.slope, <span class="variable">self</span>.intercept, r_value, _, _ = scipy.stats.linregress(x_data, y_data)
        r_squared = r_value ** <span class="number">2</span>
        
        <span class="comment"># Actualizar UI con ecuaci√≥n</span>
        equation = <span class="string">f"y = {<span class="variable">self</span>.slope:.4f}x + {<span class="variable">self</span>.intercept:.4f}"</span>
        <span class="variable">self</span>.ui.label_ecuacion.setText(equation)
        <span class="variable">self</span>.ui.label_r2.setText(<span class="string">f"R¬≤ = {r_squared:.6f}"</span>)
        
        <span class="comment"># Graficar regresi√≥n</span>
        <span class="variable">self</span>.ax2.clear()
        <span class="variable">self</span>.ax2.scatter(x_data, y_data, color=<span class="string">'blue'</span>, label=<span class="string">'Datos'</span>, s=<span class="number">60</span>, zorder=<span class="number">3</span>)
        
        x_line = np.linspace(x_data.<span class="function">min</span>(), x_data.<span class="function">max</span>(), <span class="number">100</span>)
        y_line = <span class="variable">self</span>.slope * x_line + <span class="variable">self</span>.intercept
        <span class="variable">self</span>.ax2.plot(x_line, y_line, <span class="string">'r-'</span>, label=<span class="string">'Ajuste'</span>, linewidth=<span class="number">2</span>, zorder=<span class="number">2</span>)
        
        <span class="variable">self</span>.ax2.set_xlabel(<span class="string">'Valor Crudo (ADC)'</span>, fontsize=<span class="number">10</span>)
        <span class="variable">self</span>.ax2.set_ylabel(<span class="string">'Valor Real (unidades f√≠sicas)'</span>, fontsize=<span class="number">10</span>)
        <span class="variable">self</span>.ax2.set_title(<span class="string">f'Calibraci√≥n: {equation}'</span>, fontsize=<span class="number">11</span>, weight=<span class="string">'bold'</span>)
        <span class="variable">self</span>.ax2.legend(loc=<span class="string">'best'</span>)
        <span class="variable">self</span>.ax2.grid(<span class="variable">True</span>, alpha=<span class="number">0.3</span>, linestyle=<span class="string">'--'</span>)
        <span class="variable">self</span>.canvas2.draw()
        
        <span class="variable">self</span>.calibrated = <span class="variable">True</span>
        QMessageBox.information(<span class="variable">self</span>, <span class="string">"√âxito"</span>, <span class="string">f"{equation}\nR¬≤ = {r_squared:.6f}"</span>)
        
    <span class="keyword">except</span> <span class="function">Exception</span> <span class="keyword">as</span> e:
        QMessageBox.critical(<span class="variable">self</span>, <span class="string">"Error"</span>, <span class="string">f"Fallo: {e}"</span>)</code></pre>
                </div>

                <h3 class="subsection-title">3Ô∏è‚É£ Exportaci√≥n de Datos a Excel</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Python</span>
                            <span>Funci√≥n: _export_to_excel() - Generaci√≥n de reportes</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime
<span class="keyword">from</span> PySide6.QtWidgets <span class="keyword">import</span> QFileDialog

<span class="keyword">def</span> <span class="function">_export_to_excel</span>(<span class="variable">self</span>):
    <span class="string">"""Exporta datos hist√≥ricos a archivo Excel con gr√°ficas embebidas"""</span>
    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable">self</span>.data_hombro <span class="keyword">and</span> <span class="keyword">not</span> <span class="variable">self</span>.data_codo:
        QMessageBox.warning(<span class="variable">self</span>, <span class="string">"Sin datos"</span>, <span class="string">"No hay datos para exportar"</span>)
        <span class="keyword">return</span>
    
    <span class="comment"># Di√°logo guardar archivo</span>
    filename, _ = QFileDialog.getSaveFileName(
        <span class="variable">self</span>, <span class="string">"Guardar datos"</span>,
        <span class="string">f"sensora_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"</span>,
        <span class="string">"Excel (*.xlsx)"</span>
    )
    
    <span class="keyword">if</span> <span class="keyword">not</span> filename:
        <span class="keyword">return</span>
    
    <span class="keyword">try</span>:
        <span class="comment"># Crear DataFrame con datos alineados</span>
        max_len = <span class="function">max</span>(<span class="function">len</span>(<span class="variable">self</span>.data_hombro), <span class="function">len</span>(<span class="variable">self</span>.data_codo))
        
        df = pd.DataFrame({
            <span class="string">'Tiempo_Hombro (s)'</span>: pd.Series(<span class="variable">self</span>.timestamps_hombro),
            <span class="string">'Hombro (¬∞)'</span>: pd.Series(<span class="variable">self</span>.data_hombro),
            <span class="string">'Tiempo_Codo (s)'</span>: pd.Series(<span class="variable">self</span>.timestamps_codo),
            <span class="string">'Codo (¬∞)'</span>: pd.Series(<span class="variable">self</span>.data_codo)
        })
        
        <span class="comment"># Crear Excel con XlsxWriter engine</span>
        <span class="keyword">with</span> pd.ExcelWriter(filename, engine=<span class="string">'xlsxwriter'</span>) <span class="keyword">as</span> writer:
            df.to_excel(writer, sheet_name=<span class="string">'Datos'</span>, index=<span class="variable">False</span>)
            
            workbook = writer.book
            worksheet = writer.sheets[<span class="string">'Datos'</span>]
            
            <span class="comment"># Formato de columnas</span>
            num_fmt = workbook.add_format({<span class="string">'num_format'</span>: <span class="string">'0.00'</span>})
            worksheet.set_column(<span class="string">'A:D'</span>, <span class="number">18</span>, num_fmt)
            
            <span class="comment"># Crear gr√°fica embebida</span>
            chart = workbook.add_chart({<span class="string">'type'</span>: <span class="string">'line'</span>})
            
            <span class="comment"># Serie Hombro</span>
            chart.add_series({
                <span class="string">'name'</span>: <span class="string">'Hombro'</span>,
                <span class="string">'categories'</span>: [<span class="string">'Datos'</span>, <span class="number">1</span>, <span class="number">0</span>, max_len, <span class="number">0</span>],
                <span class="string">'values'</span>: [<span class="string">'Datos'</span>, <span class="number">1</span>, <span class="number">1</span>, max_len, <span class="number">1</span>],
                <span class="string">'line'</span>: {<span class="string">'color'</span>: <span class="string">'blue'</span>, <span class="string">'width'</span>: <span class="number">2</span>}
            })
            
            <span class="comment"># Serie Codo</span>
            chart.add_series({
                <span class="string">'name'</span>: <span class="string">'Codo'</span>,
                <span class="string">'categories'</span>: [<span class="string">'Datos'</span>, <span class="number">1</span>, <span class="number">2</span>, max_len, <span class="number">2</span>],
                <span class="string">'values'</span>: [<span class="string">'Datos'</span>, <span class="number">1</span>, <span class="number">3</span>, max_len, <span class="number">3</span>],
                <span class="string">'line'</span>: {<span class="string">'color'</span>: <span class="string">'red'</span>, <span class="string">'width'</span>: <span class="number">2</span>}
            })
            
            chart.set_title({<span class="string">'name'</span>: <span class="string">'Monitoreo de √Ångulos'</span>})
            chart.set_x_axis({<span class="string">'name'</span>: <span class="string">'Tiempo (s)'</span>})
            chart.set_y_axis({<span class="string">'name'</span>: <span class="string">'√Ångulo (¬∞)'</span>})
            chart.set_style(<span class="number">10</span>)
            
            worksheet.insert_chart(<span class="string">'F2'</span>, chart, {<span class="string">'x_scale'</span>: <span class="number">1.5</span>, <span class="string">'y_scale'</span>: <span class="number">1.5</span>})
            
            <span class="comment"># Hoja de metadatos</span>
            meta = workbook.add_worksheet(<span class="string">'Metadata'</span>)
            bold = workbook.add_format({<span class="string">'bold'</span>: <span class="variable">True</span>})
            meta.write(<span class="number">0</span>, <span class="number">0</span>, <span class="string">'Fecha'</span>, bold)
            meta.write(<span class="number">0</span>, <span class="number">1</span>, datetime.now().strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>))
            meta.write(<span class="number">1</span>, <span class="number">0</span>, <span class="string">'Total muestras'</span>, bold)
            meta.write(<span class="number">1</span>, <span class="number">1</span>, max_len)
            meta.write(<span class="number">2</span>, <span class="number">0</span>, <span class="string">'Calibrado'</span>, bold)
            meta.write(<span class="number">2</span>, <span class="number">1</span>, <span class="string">'S√≠'</span> <span class="keyword">if</span> <span class="variable">self</span>.calibrated <span class="keyword">else</span> <span class="string">'No'</span>)
        
        QMessageBox.information(<span class="variable">self</span>, <span class="string">"√âxito"</span>, <span class="string">f"Archivo guardado:\n{filename}"</span>)
        
    <span class="keyword">except</span> <span class="function">Exception</span> <span class="keyword">as</span> e:
        QMessageBox.critical(<span class="variable">self</span>, <span class="string">"Error"</span>, <span class="string">f"Fallo exportaci√≥n: {e}"</span>)</code></pre>
                </div>

                <h3 class="subsection-title">4Ô∏è‚É£ Visualizaci√≥n en Tiempo Real</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Python</span>
                            <span>Funci√≥n: _on_data() - Actualizaci√≥n de gr√°ficos matplotlib</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">import</span> time

<span class="keyword">def</span> <span class="function">_on_data</span>(<span class="variable">self</span>, data_line):
    <span class="string">"""Procesa datos recibidos del ESP32 y actualiza visualizaci√≥n en tiempo real
    
    Args:
        data_line (str): L√≠nea de datos formato "SENSOR1:valor1,SENSOR2:valor2"
    """</span>
    <span class="keyword">try</span>:
        <span class="keyword">if</span> <span class="string">':'</span> <span class="keyword">not</span> <span class="keyword">in</span> data_line:
            <span class="keyword">return</span>  <span class="comment"># L√≠nea inv√°lida</span>
        
        <span class="comment"># Parsear datos (ejemplo para m√≥dulo de √°ngulos)</span>
        parts = data_line.split(<span class="string">','</span>)
        hombro_val = <span class="variable">None</span>
        codo_val = <span class="variable">None</span>
        
        <span class="keyword">for</span> part <span class="keyword">in</span> parts:
            <span class="keyword">if</span> <span class="string">'HOMBRO'</span> <span class="keyword">in</span> part:
                hombro_val = <span class="function">float</span>(part.split(<span class="string">':'</span>)[<span class="number">1</span>])
            <span class="keyword">elif</span> <span class="string">'CODO'</span> <span class="keyword">in</span> part:
                codo_val = <span class="function">float</span>(part.split(<span class="string">':'</span>)[<span class="number">1</span>])
        
        <span class="comment"># Aplicar calibraci√≥n si est√° activa</span>
        <span class="keyword">if</span> <span class="variable">self</span>.calibrated <span class="keyword">and</span> <span class="variable">self</span>.slope <span class="keyword">is</span> <span class="keyword">not</span> <span class="variable">None</span>:
            <span class="keyword">if</span> hombro_val <span class="keyword">is</span> <span class="keyword">not</span> <span class="variable">None</span>:
                hombro_val = <span class="variable">self</span>.slope * hombro_val + <span class="variable">self</span>.intercept
            <span class="keyword">if</span> codo_val <span class="keyword">is</span> <span class="keyword">not</span> <span class="variable">None</span>:
                codo_val = <span class="variable">self</span>.slope * codo_val + <span class="variable">self</span>.intercept
        
        <span class="comment"># Timestamp relativo</span>
        current_time = time.time() - <span class="variable">self</span>.start_time
        
        <span class="comment"># Actualizar datos y LCDs</span>
        <span class="keyword">if</span> hombro_val <span class="keyword">is</span> <span class="keyword">not</span> <span class="variable">None</span>:
            <span class="variable">self</span>.timestamps_hombro.append(current_time)
            <span class="variable">self</span>.data_hombro.append(hombro_val)
            <span class="variable">self</span>.ui.lcd_hombro.display(<span class="string">f"{hombro_val:.2f}"</span>)
        
        <span class="keyword">if</span> codo_val <span class="keyword">is</span> <span class="keyword">not</span> <span class="variable">None</span>:
            <span class="variable">self</span>.timestamps_codo.append(current_time)
            <span class="variable">self</span>.data_codo.append(codo_val)
            <span class="variable">self</span>.ui.lcd_codo.display(<span class="string">f"{codo_val:.2f}"</span>)
        
        <span class="comment"># Limitar ventana de datos (√∫ltimos 100 puntos)</span>
        MAX_POINTS = <span class="number">100</span>
        <span class="keyword">if</span> <span class="function">len</span>(<span class="variable">self</span>.data_hombro) &gt; MAX_POINTS:
            <span class="variable">self</span>.timestamps_hombro = <span class="variable">self</span>.timestamps_hombro[-MAX_POINTS:]
            <span class="variable">self</span>.data_hombro = <span class="variable">self</span>.data_hombro[-MAX_POINTS:]
        <span class="keyword">if</span> <span class="function">len</span>(<span class="variable">self</span>.data_codo) &gt; MAX_POINTS:
            <span class="variable">self</span>.timestamps_codo = <span class="variable">self</span>.timestamps_codo[-MAX_POINTS:]
            <span class="variable">self</span>.data_codo = <span class="variable">self</span>.data_codo[-MAX_POINTS:]
        
        <span class="comment"># Actualizar gr√°fica en tiempo real</span>
        <span class="variable">self</span>.ax.clear()
        <span class="variable">self</span>.ax.plot(<span class="variable">self</span>.timestamps_hombro, <span class="variable">self</span>.data_hombro, 
                     <span class="string">'b-'</span>, linewidth=<span class="number">2</span>, marker=<span class="string">'o'</span>, markersize=<span class="number">3</span>, label=<span class="string">'Hombro'</span>)
        <span class="variable">self</span>.ax.plot(<span class="variable">self</span>.timestamps_codo, <span class="variable">self</span>.data_codo, 
                     <span class="string">'r-'</span>, linewidth=<span class="number">2</span>, marker=<span class="string">'s'</span>, markersize=<span class="number">3</span>, label=<span class="string">'Codo'</span>)
        
        <span class="variable">self</span>.ax.set_xlabel(<span class="string">'Tiempo (s)'</span>, fontsize=<span class="number">10</span>)
        <span class="variable">self</span>.ax.set_ylabel(<span class="string">'√Ångulo (¬∞)'</span>, fontsize=<span class="number">10</span>)
        <span class="variable">self</span>.ax.set_title(<span class="string">'Monitoreo en Tiempo Real'</span>, fontsize=<span class="number">12</span>, weight=<span class="string">'bold'</span>)
        <span class="variable">self</span>.ax.legend(loc=<span class="string">'upper right'</span>)
        <span class="variable">self</span>.ax.grid(<span class="variable">True</span>, alpha=<span class="number">0.3</span>, linestyle=<span class="string">'--'</span>)
        <span class="variable">self</span>.canvas.draw()
        
    <span class="keyword">except</span> <span class="function">Exception</span> <span class="keyword">as</span> e:
        <span class="function">print</span>(<span class="string">f"[Error] _on_data: {e}"</span>)</code></pre>
                </div>

                <h3 class="subsection-title">5Ô∏è‚É£ Persistencia de Calibraci√≥n (JSON)</h3>
                
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Python</span>
                            <span>Funciones: save_calibration() / load_calibration() - Persistencia de par√°metros</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">import</span> json
<span class="keyword">import</span> os
<span class="keyword">from</span> PySide6.QtWidgets <span class="keyword">import</span> QMessageBox

<span class="keyword">def</span> <span class="function">save_calibration</span>(<span class="variable">self</span>):
    <span class="string">"""Guarda par√°metros de calibraci√≥n en archivo JSON"""</span>
    <span class="keyword">try</span>:
        calib_data = {
            <span class="string">"slope"</span>: <span class="variable">self</span>.slope,
            <span class="string">"intercept"</span>: <span class="variable">self</span>.intercept,
            <span class="string">"r_squared"</span>: <span class="variable">self</span>.r_squared,
            <span class="string">"calibrated"</span>: <span class="variable">self</span>.calibrated,
            <span class="string">"sensor_type"</span>: <span class="string">"angle_sensor"</span>,
            <span class="string">"calibration_points"</span>: <span class="function">len</span>(<span class="variable">self</span>.calib_adc)
        }
        
        <span class="keyword">with</span> <span class="function">open</span>(<span class="string">"calibration.json"</span>, <span class="string">"w"</span>) <span class="keyword">as</span> f:
            json.dump(calib_data, f, indent=<span class="number">4</span>)
        
        QMessageBox.information(<span class="variable">self</span>, <span class="string">"√âxito"</span>, <span class="string">"Calibraci√≥n guardada correctamente"</span>)
        
    <span class="keyword">except</span> <span class="function">Exception</span> <span class="keyword">as</span> e:
        QMessageBox.critical(<span class="variable">self</span>, <span class="string">"Error"</span>, <span class="string">f"No se pudo guardar: {e}"</span>)

<span class="keyword">def</span> <span class="function">load_calibration</span>(<span class="variable">self</span>):
    <span class="string">"""Carga par√°metros de calibraci√≥n desde archivo JSON"""</span>
    <span class="keyword">try</span>:
        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">"calibration.json"</span>):
            <span class="keyword">raise</span> <span class="function">FileNotFoundError</span>(<span class="string">"Archivo de calibraci√≥n no encontrado"</span>)
        
        <span class="keyword">with</span> <span class="function">open</span>(<span class="string">"calibration.json"</span>, <span class="string">"r"</span>) <span class="keyword">as</span> f:
            calib_data = json.load(f)
        
        <span class="variable">self</span>.slope = calib_data[<span class="string">"slope"</span>]
        <span class="variable">self</span>.intercept = calib_data[<span class="string">"intercept"</span>]
        <span class="variable">self</span>.r_squared = calib_data.get(<span class="string">"r_squared"</span>, <span class="variable">None</span>)
        <span class="variable">self</span>.calibrated = calib_data[<span class="string">"calibrated"</span>]
        
        QMessageBox.information(<span class="variable">self</span>, <span class="string">"√âxito"</span>, 
                              <span class="string">f"Calibraci√≥n cargada\nR¬≤: {self.r_squared:.4f}"</span>)
        
    <span class="keyword">except</span> <span class="function">Exception</span> <span class="keyword">as</span> e:
        QMessageBox.warning(<span class="variable">self</span>, <span class="string">"Advertencia"</span>, <span class="string">f"No se pudo cargar: {e}"</span>)</code></pre>
                </div>

                <div class="info-box success">
                    <strong>‚úÖ Ventajas de la Arquitectura:</strong>
                    <ul style="margin-top: 10px;">
                        <li>Separaci√≥n de l√≥gica y UI (Patr√≥n MVC)</li>
                        <li>Hilos independientes para no bloquear la interfaz</li>
                        <li>Signals/Slots de Qt para comunicaci√≥n thread-safe</li>
                        <li>Matplotlib integrado con backend Qt para gr√°ficos fluidos</li>
                    </ul>
                </div>
            </section>

            <!-- SECCI√ìN: COMUNICACI√ìN -->
            <section id="communication" class="section">
                <h2 class="section-title">üîó Protocolo de Comunicaci√≥n TCP/IP</h2>
                
                <div class="description">
                    <h3>üì° Formato de Comunicaci√≥n</h3>
                    <p>La comunicaci√≥n entre el ESP32 y la aplicaci√≥n de escritorio se realiza mediante sockets TCP/IP. El ESP32 act√∫a como servidor TCP, escuchando conexiones entrantes en el puerto <strong>8888</strong>.</p>
                    
                    <h3 style="margin-top: 15px;">üì§ Comandos de Control (PC ‚Üí ESP32)</h3>
                    <p>La aplicaci√≥n de escritorio env√≠a comandos en formato ASCII para cambiar el modo de operaci√≥n del ESP32:</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div class="info-box">
                        <strong>MODO:ANGULO_SIMPLE</strong><br>
                        Activa sensor de √°ngulo simple<br>
                        <em>Respuesta: ANGULO_SIMPLE_OK</em>
                    </div>
                    <div class="info-box">
                        <strong>MODO:BRAZO_ANGULO</strong><br>
                        Activa brazo rob√≥tico 3 ejes<br>
                        <em>Respuesta: BRAZO_ANGULO_OK</em>
                    </div>
                    <div class="info-box">
                        <strong>MODO:DISTANCIA_IR</strong><br>
                        Sensor infrarrojo de proximidad<br>
                        <em>Respuesta: DISTANCIA_IR_OK</em>
                    </div>
                    <div class="info-box">
                        <strong>MODO:DISTANCIA_ULTRA</strong><br>
                        Sensor ultras√≥nico HC-SR04<br>
                        <em>Respuesta: DISTANCIA_ULTRA_OK</em>
                    </div>
                    <div class="info-box">
                        <strong>MODO:THERMOREGULATION</strong><br>
                        Sensores de temperatura m√∫ltiples<br>
                        <em>Respuesta: THERMOREGULATION_OK</em>
                    </div>
                    <div class="info-box">
                        <strong>MODO:GAS_REGULATION</strong><br>
                        Sensores de gas MQ2/MQ3<br>
                        <em>Respuesta: GAS_REGULATION_OK</em>
                    </div>
                    <div class="info-box">
                        <strong>MODO:BRIGHTNESS</strong><br>
                        Sensor de luz LDR<br>
                        <em>Respuesta: BRIGHTNESS_OK</em>
                    </div>
                    <div class="info-box">
                        <strong>MODO:COLOR_TCS</strong><br>
                        Sensor de color TCS3200<br>
                        <em>Respuesta: COLOR_TCS_OK</em>
                    </div>
                </div>

                <div class="description" style="margin-top: 20px;">
                    <h3>üì• Formato de Datos (ESP32 ‚Üí PC)</h3>
                    <p>El ESP32 env√≠a datos de sensores en formato <strong>clave:valor</strong> separados por comas:</p>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Text</span>
                            <span>Ejemplos de tramas de datos</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="comment"># Brazo rob√≥tico (3 ejes)</span>
HOMBRO:<span class="number">1234</span>,CODO:<span class="number">2345</span>,MUNECA:<span class="number">3456</span>

<span class="comment"># Termorregulaci√≥n (m√∫ltiples sensores)</span>
LM35:<span class="number">25.4</span>,DS18B20:<span class="number">26.1</span>,MAX6675:<span class="number">120.5</span>

<span class="comment"># Sensores de gas (MQ2/MQ3)</span>
RS:<span class="number">1234.5</span>,RO:<span class="number">5678.9</span>,PPM:<span class="number">150.2</span>

<span class="comment"># Sensor de color TCS3200</span>
R:<span class="number">120</span>,G:<span class="number">200</span>,B:<span class="number">80</span>,CLEAR:<span class="number">450</span>

<span class="comment"># Distancia ultras√≥nica</span>
DISTANCE:<span class="number">34.5</span>

<span class="comment"># Sensor de luz LDR</span>
LUX:<span class="number">450</span>,ADC:<span class="number">2048</span></code></pre>
                </div>

                <div class="info-box warning" style="margin-top: 20px;">
                    <strong>‚ö†Ô∏è Consideraciones Importantes:</strong>
                    <ul style="margin-top: 10px;">
                        <li>Cada trama termina con salto de l√≠nea (<code>\n</code>)</li>
                        <li>La frecuencia de muestreo es configurable (100-1000 ms)</li>
                        <li>Los valores ADC son de 12 bits (0-4095)</li>
                        <li>La reconexi√≥n autom√°tica se activa tras 3 intentos fallidos</li>
                    </ul>
                </div>

                <div class="code-block" style="margin-top: 20px;">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Python</span>
                            <span>Ejemplo: Parseo de datos en aplicaci√≥n Desktop</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">parse_data</span>(data_line):
    <span class="string">"""Parsea l√≠nea de datos del ESP32
    
    Args:
        data_line (str): L√≠nea con formato "KEY1:val1,KEY2:val2,..."
    
    Returns:
        dict: Diccionario con pares clave-valor
    """</span>
    data_dict = {}
    
    <span class="keyword">try</span>:
        <span class="comment"># Separar por comas</span>
        parts = data_line.strip().split(<span class="string">','</span>)
        
        <span class="keyword">for</span> part <span class="keyword">in</span> parts:
            <span class="keyword">if</span> <span class="string">':'</span> <span class="keyword">in</span> part:
                key, value = part.split(<span class="string">':'</span>, <span class="number">1</span>)
                
                <span class="comment"># Intentar conversi√≥n a float</span>
                <span class="keyword">try</span>:
                    data_dict[key.strip()] = <span class="function">float</span>(value.strip())
                <span class="keyword">except</span> <span class="function">ValueError</span>:
                    data_dict[key.strip()] = value.strip()
        
        <span class="keyword">return</span> data_dict
        
    <span class="keyword">except</span> <span class="function">Exception</span> <span class="keyword">as</span> e:
        <span class="function">print</span>(<span class="string">f"Error parsing data: {e}"</span>)
        <span class="keyword">return</span> {}

<span class="comment"># Ejemplo de uso</span>
data = parse_data(<span class="string">"HOMBRO:1234,CODO:2345,MUNECA:3456"</span>)
<span class="function">print</span>(data)  <span class="comment"># {'HOMBRO': 1234.0, 'CODO': 2345.0, 'MUNECA': 3456.0}</span></code></pre>
                </div>
            </section>

            <!-- SECCI√ìN: CALIBRACI√ìN -->
            <section id="calibration" class="section">
                <h2 class="section-title">üß™ Algoritmos de Calibraci√≥n</h2>
                
                <div class="description">
                    <p>Los sensores requieren calibraci√≥n para convertir valores brutos (ADC, voltaje, frecuencia) en unidades f√≠sicas (¬∞C, ¬∞, cm, ppm). SensoraCore implementa m√∫ltiples algoritmos matem√°ticos adaptados a cada tipo de sensor.</p>
                </div>

                <h3 class="subsection-title">1Ô∏è‚É£ Calibraci√≥n Lineal (Sensores Anal√≥gicos)</h3>
                
                <div class="description">
                    <h3>üìä Ecuaci√≥n: y = m¬∑x + b</h3>
                    <p><strong>Aplicable a:</strong> Potenci√≥metros, LDR, CNY70, LM35, Ultras√≥nico</p>
                    <p><strong>M√©todo:</strong> Regresi√≥n lineal por m√≠nimos cuadrados</p>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Python</span>
                            <span>Implementaci√≥n de calibraci√≥n lineal con scipy</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">from</span> scipy.stats <span class="keyword">import</span> linregress
<span class="keyword">import</span> numpy <span class="keyword">as</span> np

<span class="keyword">def</span> <span class="function">calibrate_linear</span>(adc_values, physical_values):
    <span class="string">"""Realiza calibraci√≥n lineal por regresi√≥n de m√≠nimos cuadrados
    
    Args:
        adc_values (list): Valores ADC medidos (0-4095)
        physical_values (list): Valores f√≠sicos correspondientes (¬∞, cm, lux, etc.)
    
    Returns:
        tuple: (slope, intercept, r_squared)
    """</span>
    <span class="comment"># Convertir a arrays numpy</span>
    x = np.array(adc_values, dtype=<span class="function">float</span>)
    y = np.array(physical_values, dtype=<span class="function">float</span>)
    
    <span class="comment"># Regresi√≥n lineal</span>
    slope, intercept, r_value, p_value, std_err = linregress(x, y)
    r_squared = r_value ** <span class="number">2</span>
    
    <span class="keyword">return</span> slope, intercept, r_squared

<span class="comment"># Ejemplo: Calibraci√≥n de sensor de √°ngulo</span>
adc_calibration = [<span class="number">0</span>, <span class="number">512</span>, <span class="number">1024</span>, <span class="number">2048</span>, <span class="number">3072</span>, <span class="number">4095</span>]
angle_calibration = [<span class="number">0</span>, <span class="number">30</span>, <span class="number">60</span>, <span class="number">120</span>, <span class="number">180</span>, <span class="number">240</span>]

m, b, r2 = calibrate_linear(adc_calibration, angle_calibration)
<span class="function">print</span>(<span class="string">f"Ecuaci√≥n: y = {m:.4f}x + {b:.4f}"</span>)
<span class="function">print</span>(<span class="string">f"R¬≤ = {r2:.4f}"</span>)  <span class="comment"># R¬≤ cercano a 1 indica buen ajuste</span></code></pre>
                </div>

                <h3 class="subsection-title">2Ô∏è‚É£ Calibraci√≥n Logar√≠tmica (Sensores de Gas MQ)</h3>
                
                <div class="description">
                    <h3>üìä Ecuaci√≥n: log(PPM) = m¬∑log(Rs/R0) + b</h3>
                    <p><strong>Aplicable a:</strong> MQ2 (humo, gas combustible), MQ3 (alcohol)</p>
                    <p><strong>M√©todo:</strong> Regresi√≥n logar√≠tmica en escala log-log</p>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Python</span>
                            <span>Calibraci√≥n logar√≠tmica para sensores MQ</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">import</span> numpy <span class="keyword">as</span> np
<span class="keyword">from</span> scipy.stats <span class="keyword">import</span> linregress

<span class="keyword">def</span> <span class="function">calibrate_mq_sensor</span>(rs_r0_values, ppm_values):
    <span class="string">"""Calibra sensor MQ con curva logar√≠tmica
    
    Args:
        rs_r0_values (list): Ratios Rs/R0 medidos
        ppm_values (list): Concentraciones PPM conocidas
    
    Returns:
        tuple: (slope_log, intercept_log, r_squared)
    """</span>
    <span class="comment"># Transformaci√≥n logar√≠tmica</span>
    log_rs_r0 = np.log10(rs_r0_values)
    log_ppm = np.log10(ppm_values)
    
    <span class="comment"># Regresi√≥n en espacio log-log</span>
    slope, intercept, r_value, _, _ = linregress(log_rs_r0, log_ppm)
    r_squared = r_value ** <span class="number">2</span>
    
    <span class="keyword">return</span> slope, intercept, r_squared

<span class="comment"># Datos de calibraci√≥n MQ2 (ejemplo con gas propano)</span>
rs_r0 = [<span class="number">9.8</span>, <span class="number">3.0</span>, <span class="number">1.5</span>, <span class="number">0.8</span>, <span class="number">0.4</span>]
ppm = [<span class="number">200</span>, <span class="number">500</span>, <span class="number">1000</span>, <span class="number">2000</span>, <span class="number">5000</span>]

m_log, b_log, r2 = calibrate_mq_sensor(rs_r0, ppm)

<span class="comment"># Funci√≥n de conversi√≥n calibrada</span>
<span class="keyword">def</span> <span class="function">rs_r0_to_ppm</span>(rs_r0_ratio):
    log_ppm = m_log * np.log10(rs_r0_ratio) + b_log
    <span class="keyword">return</span> <span class="number">10</span> ** log_ppm</code></pre>
                </div>

                <h3 class="subsection-title">3Ô∏è‚É£ Calibraci√≥n Polin√≥mica (Termorregulaci√≥n Avanzada)</h3>
                
                <div class="description">
                    <h3>üìä Ecuaci√≥n: y = a‚ÇÄ + a‚ÇÅx + a‚ÇÇx¬≤ + ... + a‚Çôx‚Åø</h3>
                    <p><strong>Aplicable a:</strong> Termopares (MAX6675), sensores no lineales</p>
                    <p><strong>M√©todo:</strong> Ajuste polin√≥mico de grado n</p>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Python</span>
                            <span>Calibraci√≥n polin√≥mica con numpy</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">import</span> numpy <span class="keyword">as</span> np

<span class="keyword">def</span> <span class="function">calibrate_polynomial</span>(x_values, y_values, degree=<span class="number">2</span>):
    <span class="string">"""Calibraci√≥n polin√≥mica de grado n
    
    Args:
        x_values (list): Valores de entrada (voltaje, ADC, etc.)
        y_values (list): Valores de salida (temperatura, etc.)
        degree (int): Grado del polinomio (2 = cuadr√°tico, 3 = c√∫bico)
    
    Returns:
        numpy.poly1d: Objeto polinomio para evaluaci√≥n
    """</span>
    coefficients = np.polyfit(x_values, y_values, degree)
    polynomial = np.poly1d(coefficients)
    <span class="keyword">return</span> polynomial

<span class="comment"># Ejemplo: Termopar tipo K (MAX6675)</span>
voltage_mv = [<span class="number">0</span>, <span class="number">4.1</span>, <span class="number">8.1</span>, <span class="number">12.2</span>, <span class="number">16.4</span>]
temp_c = [<span class="number">0</span>, <span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>, <span class="number">400</span>]

poly = calibrate_polynomial(voltage_mv, temp_c, degree=<span class="number">2</span>)

<span class="comment"># Uso del polinomio</span>
measured_voltage = <span class="number">10.5</span>
temperature = poly(measured_voltage)
<span class="function">print</span>(<span class="string">f"Temperatura: {temperature:.2f}¬∞C"</span>)</code></pre>
                </div>

                <h3 class="subsection-title">4Ô∏è‚É£ Compensaci√≥n T√©rmica (Sensores de Distancia)</h3>
                
                <div class="description">
                    <p><strong>Problema:</strong> La velocidad del sonido var√≠a con la temperatura: v = 331.3 + 0.606¬∑T</p>
                    <p><strong>Soluci√≥n:</strong> Ajustar mediciones de distancia ultras√≥nica seg√∫n temperatura ambiente</p>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Python</span>
                            <span>Compensaci√≥n t√©rmica para HC-SR04</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">compensate_temperature</span>(distance_cm, temp_celsius):
    <span class="string">"""Compensa distancia ultras√≥nica seg√∫n temperatura
    
    Args:
        distance_cm (float): Distancia medida en cm
        temp_celsius (float): Temperatura ambiente en ¬∞C
    
    Returns:
        float: Distancia compensada
    """</span>
    <span class="comment"># Velocidad del sonido a 20¬∞C (referencia)</span>
    v_ref = <span class="number">343.0</span>  <span class="comment"># m/s</span>
    
    <span class="comment"># Velocidad corregida por temperatura</span>
    v_actual = <span class="number">331.3</span> + <span class="number">0.606</span> * temp_celsius
    
    <span class="comment"># Factor de correcci√≥n</span>
    correction_factor = v_actual / v_ref
    
    <span class="keyword">return</span> distance_cm * correction_factor</code></pre>
                </div>

                <h3 class="subsection-title">5Ô∏è‚É£ Normalizaci√≥n RGB (Sensor TCS3200)</h3>
                
                <div class="description">
                    <p><strong>Objetivo:</strong> Independizar lecturas de color de la intensidad lum√≠nica ambiente</p>
                    <p><strong>M√©todo:</strong> Normalizaci√≥n por canal CLEAR</p>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <div class="code-label">
                            <span class="language-tag">Python</span>
                            <span>Normalizaci√≥n RGB con TCS3200</span>
                        </div>
                        <button class="copy-btn" onclick="copyCode(this)">üìã Copiar</button>
                        <button class="copy-image-btn" onclick="copyAsImage(this)">üñºÔ∏è Copiar Imagen</button>
                    </div>
                    <pre><code><span class="keyword">def</span> <span class="function">normalize_rgb</span>(r, g, b, clear):
    <span class="string">"""Normaliza valores RGB por intensidad total
    
    Args:
        r, g, b (int): Valores RGB brutos
        clear (int): Valor de canal CLEAR (intensidad total)
    
    Returns:
        tuple: (r_norm, g_norm, b_norm) en rango [0, 255]
    """</span>
    <span class="keyword">if</span> clear == <span class="number">0</span>:
        <span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>
    
    <span class="comment"># Normalizaci√≥n por intensidad</span>
    r_norm = (<span class="function">int</span>)((<span class="function">float</span>(r) / clear) * <span class="number">255</span>)
    g_norm = (<span class="function">int</span>)((<span class="function">float</span>(g) / clear) * <span class="number">255</span>)
    b_norm = (<span class="function">int</span>)((<span class="function">float</span>(b) / clear) * <span class="number">255</span>)
    
    <span class="keyword">return</span> r_norm, g_norm, b_norm</code></pre>
                </div>
            </section>

            <!-- SECCI√ìN: GR√ÅFICAS INTERACTIVAS -->
            <section id="graphs" class="section">
                <h2 class="section-title">üìä Gr√°ficas de Calibraci√≥n Interactivas</h2>
                
                <div class="description">
                    <p>Visualiza las curvas caracter√≠sticas de los sensores con gr√°ficas interactivas usando Plotly.js. Puedes hacer zoom, desplazarte, alternar escalas y exportar como imagen PNG.</p>
                </div>

                <div class="graph-controls">
                    <div class="control-group">
                        <label for="sensorSelect">Sensor:</label>
                        <select id="sensorSelect" onchange="updateGraph()">
                            <option value="">Selecciona un sensor...</option>
                            <option value="thermocouple">Termopares (Tipos E, J, K, R)</option>
                            <option value="mq_gas">MQ2/MQ3 - Curva de Gases</option>
                            <option value="ldr">LDR - Luminancia</option>
                            <option value="tcs3200">TCS3200 - Respuesta RGB</option>
                            <option value="distance">HC-SR04 - Regresi√≥n Lineal Distancia</option>
                            <option value="angle">Potenci√≥metro - Regresi√≥n Lineal √Ångulo</option>
                            <option value="custom">Funci√≥n Personalizada</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="logScaleX" onchange="updateGraph()">
                            Escala Log X
                        </label>
                        <label>
                            <input type="checkbox" id="logScaleY" onchange="updateGraph()">
                            Escala Log Y
                        </label>
                    </div>
                </div>

                <div id="customFunctionDiv" class="control-group" style="display:none; margin-top:15px;">
                    <label for="customFunction">Funci√≥n personalizada (JavaScript):</label>
                    <textarea id="customFunction" rows="3" placeholder="Ejemplo: Math.sqrt(x) o x**2 + 2*x + 1"></textarea>
                    <button class="btn-primary" onclick="updateGraph()">Graficar</button>
                </div>

                <div id="plotlyGraph" style="margin-top: 20px; border: 1px solid #2d3748; border-radius: 8px; background: #1a202c;">
                    <div style="text-align: center; color: #a0aec0; padding: 80px 20px;">
                        <h3>üìä Selecciona un sensor para visualizar su curva de calibraci√≥n</h3>
                        <p>Las gr√°ficas son interactivas: puedes hacer zoom, desplazarte y exportar como imagen.</p>
                    </div>
                </div>
            </section>

    <script>
        let plotlyLoaded = false;
        let html2canvasLoaded = false;

        // Cargar librer√≠a Plotly din√°micamente
        function loadPlotly() {
            if (!plotlyLoaded) {
                const script = document.createElement('script');
                script.src = 'https://cdn.plot.ly/plotly-2.27.0.min.js';
                script.onload = () => {
                    plotlyLoaded = true;
                    console.log('Plotly.js cargado correctamente');
                };
                document.head.appendChild(script);
            }
        }

        // Cargar html2canvas
        function loadHtml2Canvas() {
            if (!html2canvasLoaded) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = () => {
                    html2canvasLoaded = true;
                    console.log('html2canvas cargado correctamente');
                };
                document.head.appendChild(script);
            }
        }

        // Funci√≥n para copiar c√≥digo
        function copyCode(button) {
            const codeBlock = button.closest('.code-block').querySelector('code');
            const text = codeBlock.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                button.textContent = '‚úÖ Copiado';
                setTimeout(() => {
                    button.textContent = 'üìã Copiar';
                }, 2000);
            }).catch(err => {
                console.error('Error al copiar:', err);
                button.textContent = '‚ùå Error';
                setTimeout(() => {
                    button.textContent = 'üìã Copiar';
                }, 2000);
            });
        }

        // Funci√≥n para copiar como imagen
        function copyAsImage(button) {
            if (!html2canvasLoaded) {
                alert('Cargando librer√≠a html2canvas...');
                loadHtml2Canvas();
                return;
            }

            const codeBlock = button.closest('.code-block');
            button.textContent = '‚è≥ Generando...';
            
            html2canvas(codeBlock, {
                backgroundColor: '#1a202c',
                scale: 2
            }).then(canvas => {
                canvas.toBlob(blob => {
                    const item = new ClipboardItem({ 'image/png': blob });
                    navigator.clipboard.write([item]).then(() => {
                        button.textContent = 'üñºÔ∏è Copiado';
                        setTimeout(() => {
                            button.textContent = 'üñºÔ∏è Copiar Imagen';
                        }, 2000);
                    });
                });
            }).catch(err => {
                console.error('Error al generar imagen:', err);
                button.textContent = '‚ùå Error';
                setTimeout(() => {
                    button.textContent = 'üñºÔ∏è Copiar Imagen';
                }, 2000);
            });
        }

        // Navegaci√≥n entre secciones
        function showSection(sectionId) {
            // Ocultar todas las secciones
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Remover clase active de todos los botones
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Mostrar la secci√≥n seleccionada
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                
                // Marcar el bot√≥n como activo
                event.target.classList.add('active');
                
                // Scroll suave al inicio de la secci√≥n
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Navegaci√≥n suave (alternativa)
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Datos para gr√°ficas
        function getThermocoupleData(type) {
            const data = {
                'e': { temp: [-200, 0, 200, 400, 600, 800, 1000], voltage: [-8.825, 0, 13.421, 28.946, 45.093, 61.017, 76.358] },
                'j': { temp: [-200, 0, 200, 400, 600, 800, 1000], voltage: [-8.095, 0, 10.777, 21.846, 33.096, 45.494, 57.953] },
                'k': { temp: [-200, 0, 200, 400, 600, 800, 1000], voltage: [-5.891, 0, 8.138, 16.397, 24.905, 33.275, 41.276] },
                'r': { temp: [-50, 0, 200, 400, 600, 800, 1000], voltage: [-0.226, 0, 1.469, 3.408, 5.583, 7.950, 10.506] }
            };
            return data[type];
        }

        function getMQData() {
            // Curva caracter√≠stica MQ2 para propano (log-log)
            const rs_r0 = [10, 5, 3, 2, 1, 0.6, 0.4];
            const ppm = [200, 500, 1000, 2000, 5000, 10000, 20000];
            return { rs_r0, ppm };
        }

        function getLDRData() {
            // Curva resistencia vs luminancia
            const lux = [1, 10, 100, 1000, 10000];
            const resistance = [100000, 10000, 1000, 100, 10]; // Ohms
            return { lux, resistance };
        }

        function getTCS3200Data() {
            // Respuesta espectral normalizada
            const wavelength = [400, 450, 500, 550, 600, 650, 700, 750];
            const red = [0.1, 0.2, 0.3, 0.5, 0.9, 1.0, 0.6, 0.2];
            const green = [0.1, 0.3, 0.7, 1.0, 0.6, 0.3, 0.1, 0.05];
            const blue = [0.8, 1.0, 0.5, 0.2, 0.1, 0.05, 0.02, 0.01];
            return { wavelength, red, green, blue };
        }

        function getLinearDistanceData() {
            // Datos de calibraci√≥n HC-SR04
            const adc = [100, 250, 500, 750, 1000, 1250, 1500, 1750, 2000, 2500, 3000, 3500, 4000, 4095];
            const distance = [5, 15, 30, 45, 60, 75, 90, 105, 120, 150, 180, 210, 240, 250];
            
            // Calcular regresi√≥n lineal
            const n = adc.length;
            const sum_x = adc.reduce((a, b) => a + b, 0);
            const sum_y = distance.reduce((a, b) => a + b, 0);
            const sum_xy = adc.reduce((sum, x, i) => sum + x * distance[i], 0);
            const sum_x2 = adc.reduce((sum, x) => sum + x * x, 0);
            
            const slope = (n * sum_xy - sum_x * sum_y) / (n * sum_x2 - sum_x * sum_x);
            const intercept = (sum_y - slope * sum_x) / n;
            
            // R¬≤
            const mean_y = sum_y / n;
            const ss_tot = distance.reduce((sum, y) => sum + Math.pow(y - mean_y, 2), 0);
            const ss_res = distance.reduce((sum, y, i) => sum + Math.pow(y - (slope * adc[i] + intercept), 2), 0);
            const r2 = 1 - (ss_res / ss_tot);
            
            return { adc, distance, slope, intercept, r2 };
        }

        function getLinearAngleData() {
            // Datos de calibraci√≥n potenci√≥metro
            const adc = [0, 512, 1024, 1536, 2048, 2560, 3072, 3584, 4095];
            const angle = [0, 30, 60, 90, 120, 180, 220, 270, 300];
            
            // Calcular regresi√≥n
            const n = adc.length;
            const sum_x = adc.reduce((a, b) => a + b, 0);
            const sum_y = angle.reduce((a, b) => a + b, 0);
            const sum_xy = adc.reduce((sum, x, i) => sum + x * angle[i], 0);
            const sum_x2 = adc.reduce((sum, x) => sum + x * x, 0);
            
            const slope = (n * sum_xy - sum_x * sum_y) / (n * sum_x2 - sum_x * sum_x);
            const intercept = (sum_y - slope * sum_x) / n;
            
            const mean_y = sum_y / n;
            const ss_tot = angle.reduce((sum, y) => sum + Math.pow(y - mean_y, 2), 0);
            const ss_res = angle.reduce((sum, y, i) => sum + Math.pow(y - (slope * adc[i] + intercept), 2), 0);
            const r2 = 1 - (ss_res / ss_tot);
            
            return { adc, angle, slope, intercept, r2 };
        }

        function updateGraph() {
            if (!plotlyLoaded) {
                alert('Cargando Plotly.js...');
                loadPlotly();
                return;
            }

            const sensorType = document.getElementById('sensorSelect').value;
            const logX = document.getElementById('logScaleX').checked;
            const logY = document.getElementById('logScaleY').checked;
            
            if (!sensorType) {
                resetGraph();
                return;
            }

            // Mostrar/ocultar funci√≥n personalizada
            document.getElementById('customFunctionDiv').style.display = 
                (sensorType === 'custom') ? 'block' : 'none';

            let data, layout;

            if (sensorType === 'thermocouple') {
                const types = ['e', 'j', 'k', 'r'];
                const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'];
                
                data = types.map((type, index) => {
                    const tcData = getThermocoupleData(type);
                    return {
                        x: tcData.temp,
                        y: tcData.voltage,
                        mode: 'lines+markers',
                        name: `Tipo ${type.toUpperCase()}`,
                        line: { color: colors[index], width: 3 },
                        marker: { size: 6 }
                    };
                });
                
                layout = {
                    title: 'Termopares - Curvas Caracter√≠sticas',
                    xaxis: { title: 'Temperatura (¬∞C)', type: logX ? 'log' : 'linear' },
                    yaxis: { title: 'Voltaje (mV)', type: logY ? 'log' : 'linear' },
                    paper_bgcolor: '#1a202c',
                    plot_bgcolor: '#2d3748',
                    font: { color: '#e2e8f0' },
                    height: 600
                };
            }
            else if (sensorType === 'mq_gas') {
                const mqData = getMQData();
                
                data = [{
                    x: mqData.rs_r0,
                    y: mqData.ppm,
                    mode: 'lines+markers',
                    name: 'MQ2 - Propano',
                    line: { color: '#10b981', width: 3 },
                    marker: { size: 8 }
                }];
                
                layout = {
                    title: 'MQ2/MQ3 - Curva Caracter√≠stica (Propano)',
                    xaxis: { title: 'Rs/R0', type: 'log' },
                    yaxis: { title: 'Concentraci√≥n (PPM)', type: 'log' },
                    paper_bgcolor: '#1a202c',
                    plot_bgcolor: '#2d3748',
                    font: { color: '#e2e8f0' },
                    height: 600,
                    annotations: [{
                        text: 'Curva logar√≠tmica t√≠pica de sensores MQ',
                        xref: 'paper',
                        yref: 'paper',
                        x: 0.5,
                        y: 1.1,
                        showarrow: false,
                        font: { size: 12, color: '#a0aec0' }
                    }]
                };
            }
            else if (sensorType === 'ldr') {
                const ldrData = getLDRData();
                
                data = [{
                    x: ldrData.lux,
                    y: ldrData.resistance,
                    mode: 'lines+markers',
                    name: 'LDR',
                    line: { color: '#f59e0b', width: 3 },
                    marker: { size: 8 }
                }];
                
                layout = {
                    title: 'LDR - Resistencia vs Luminancia',
                    xaxis: { title: 'Luminancia (lux)', type: 'log' },
                    yaxis: { title: 'Resistencia (Œ©)', type: 'log' },
                    paper_bgcolor: '#1a202c',
                    plot_bgcolor: '#2d3748',
                    font: { color: '#e2e8f0' },
                    height: 600
                };
            }
            else if (sensorType === 'tcs3200') {
                const tcsData = getTCS3200Data();
                
                data = [
                    {
                        x: tcsData.wavelength,
                        y: tcsData.red,
                        mode: 'lines+markers',
                        name: 'Rojo',
                        line: { color: '#ef4444', width: 3 }
                    },
                    {
                        x: tcsData.wavelength,
                        y: tcsData.green,
                        mode: 'lines+markers',
                        name: 'Verde',
                        line: { color: '#10b981', width: 3 }
                    },
                    {
                        x: tcsData.wavelength,
                        y: tcsData.blue,
                        mode: 'lines+markers',
                        name: 'Azul',
                        line: { color: '#3b82f6', width: 3 }
                    }
                ];
                
                layout = {
                    title: 'TCS3200 - Respuesta Espectral RGB',
                    xaxis: { title: 'Longitud de onda (nm)', type: logX ? 'log' : 'linear' },
                    yaxis: { title: 'Respuesta Normalizada', type: logY ? 'log' : 'linear' },
                    paper_bgcolor: '#1a202c',
                    plot_bgcolor: '#2d3748',
                    font: { color: '#e2e8f0' },
                    height: 600
                };
            }
            else if (sensorType === 'distance') {
                const distData = getLinearDistanceData();
                const line_x = [0, 4095];
                const line_y = line_x.map(x => distData.slope * x + distData.intercept);
                
                data = [
                    {
                        x: distData.adc,
                        y: distData.distance,
                        mode: 'markers',
                        name: 'Puntos de calibraci√≥n',
                        marker: { size: 10, color: '#3b82f6' }
                    },
                    {
                        x: line_x,
                        y: line_y,
                        mode: 'lines',
                        name: `y = ${distData.slope.toFixed(4)}x + ${distData.intercept.toFixed(2)}`,
                        line: { color: '#ef4444', width: 2, dash: 'dash' }
                    }
                ];
                
                layout = {
                    title: `HC-SR04 - Regresi√≥n Lineal (R¬≤ = ${distData.r2.toFixed(4)})`,
                    xaxis: { title: 'ADC (0-4095)', type: logX ? 'log' : 'linear' },
                    yaxis: { title: 'Distancia (cm)', type: logY ? 'log' : 'linear' },
                    paper_bgcolor: '#1a202c',
                    plot_bgcolor: '#2d3748',
                    font: { color: '#e2e8f0' },
                    height: 600
                };
            }
            else if (sensorType === 'angle') {
                const angleData = getLinearAngleData();
                const line_x = [0, 4095];
                const line_y = line_x.map(x => angleData.slope * x + angleData.intercept);
                
                data = [
                    {
                        x: angleData.adc,
                        y: angleData.angle,
                        mode: 'markers',
                        name: 'Puntos de calibraci√≥n',
                        marker: { size: 10, color: '#10b981' }
                    },
                    {
                        x: line_x,
                        y: line_y,
                        mode: 'lines',
                        name: `y = ${angleData.slope.toFixed(4)}x + ${angleData.intercept.toFixed(2)}`,
                        line: { color: '#f59e0b', width: 2, dash: 'dash' }
                    }
                ];
                
                layout = {
                    title: `Potenci√≥metro - Regresi√≥n Lineal (R¬≤ = ${angleData.r2.toFixed(4)})`,
                    xaxis: { title: 'ADC (0-4095)', type: logX ? 'log' : 'linear' },
                    yaxis: { title: '√Ångulo (¬∞)', type: logY ? 'log' : 'linear' },
                    paper_bgcolor: '#1a202c',
                    plot_bgcolor: '#2d3748',
                    font: { color: '#e2e8f0' },
                    height: 600
                };
            }
            else if (sensorType === 'custom') {
                const funcStr = document.getElementById('customFunction').value;
                if (!funcStr) {
                    alert('Ingresa una funci√≥n matem√°tica');
                    return;
                }
                
                try {
                    const x = [];
                    const y = [];
                    for (let i = 0; i <= 100; i++) {
                        const xVal = i / 10;
                        x.push(xVal);
                        y.push(eval(funcStr.replace(/x/g, xVal)));
                    }
                    
                    data = [{
                        x: x,
                        y: y,
                        mode: 'lines',
                        name: funcStr,
                        line: { color: '#8b5cf6', width: 3 }
                    }];
                    
                    layout = {
                        title: `Funci√≥n Personalizada: ${funcStr}`,
                        xaxis: { title: 'x', type: logX ? 'log' : 'linear' },
                        yaxis: { title: 'f(x)', type: logY ? 'log' : 'linear' },
                        paper_bgcolor: '#1a202c',
                        plot_bgcolor: '#2d3748',
                        font: { color: '#e2e8f0' },
                        height: 600
                    };
                } catch (e) {
                    alert('Error en la funci√≥n: ' + e.message);
                    return;
                }
            }

            Plotly.newPlot('plotlyGraph', data, layout, { responsive: true });
        }

        function resetGraph() {
            document.getElementById('logScaleX').checked = false;
            document.getElementById('logScaleY').checked = false;
            document.getElementById('customFunctionDiv').style.display = 'none';
            
            document.getElementById('plotlyGraph').innerHTML = `
                <div style="text-align: center; color: #a0aec0; padding: 80px 20px;">
                    <h3>üìä Selecciona un sensor para visualizar su curva de calibraci√≥n</h3>
                    <p>Las gr√°ficas son interactivas: puedes hacer zoom, desplazarte y exportar como imagen.</p>
                </div>
            `;
        }

        // Efecto de aparici√≥n progresiva al cargar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('SensoraCore - Documentaci√≥n cargada correctamente');
            loadHtml2Canvas(); // Cargar la librer√≠a al inicio
            loadPlotly(); // Cargar Plotly
        });
    </script>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p><strong>SensoraCore</strong> - Documentaci√≥n T√©cnica del Sistema de Sensores WiFi ESP32</p>
        <p>Versi√≥n Beta 1.0 | Creado el 25 de Mayo de 2024 | √öltima actualizaci√≥n: 23 de Noviembre de 2024</p>
        <p>M√≥dulos Did√°cticos para Caracterizaci√≥n y Calibraci√≥n de Sensores Industriales</p>
        <p><a href="../index.html">Volver al Inicio</a> | <a href="https://github.com/YamithR/SensoraCore">GitHub Repository</a> | <a href="https://github.com/YamithR">@YamithR</a></p>
        <p>&copy; 2024 SensoraCore Project</p>
    </footer>
</body>
</html>
